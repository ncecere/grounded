# Grounded Refactoring Progress

## 2026-01-17: Extract shared source CRUD + run helpers

### Completed Task
**Task:** Extract shared source CRUD + run helpers for sources and shared-kbs routes
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/source-helpers.ts`

2. **Extracted shared validation schemas:**
   - `createSourceBaseSchema` - Base schema for source creation
   - `createSourceWithKbIdSchema` - Schema with kbId for tenant sources
   - `updateSourceSchema` - Schema for partial source updates
   - `triggerRunSchema` - Schema for run trigger options

3. **Extracted shared helper functions:**
   - `buildSourceUpdateData()` - Merges partial config updates with existing config
   - `calculateSourceStats()` - Computes page count and chunk count for a source
   - `cascadeSoftDeleteSourceChunks()` - Soft-deletes all chunks for a source
   - `findRunningRun()` - Checks if a source has an active run
   - `createSourceRun()` - Creates a new source run record
   - `queueSourceRunJob()` - Queues a source run job for processing

4. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/sources.ts` - Tenant source routes
   - `apps/api/src/routes/admin/shared-kbs.ts` - Global KB source routes

5. **Added tests:**
   - `apps/api/src/services/source-helpers.test.ts` - 23 tests covering all schemas and helpers

### Code Reduction
- Eliminated ~100 lines of duplicate code between sources.ts and shared-kbs.ts
- Centralized validation schemas prevent drift between routes
- Stats calculation, cascade delete, and run management now use single implementations

### Files Changed
- `apps/api/src/services/source-helpers.ts` (NEW)
- `apps/api/src/services/source-helpers.test.ts` (NEW)
- `apps/api/src/routes/sources.ts` (MODIFIED)
- `apps/api/src/routes/admin/shared-kbs.ts` (MODIFIED)
- `apps/api/package.json` (MODIFIED - added test script)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Unify widget /chat and /chat/stream handlers

### Completed Task
**Task:** Unify widget /chat and /chat/stream handlers into a shared streaming function
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/widget-chat-helpers.ts`

2. **Extracted shared validation schema:**
   - `widgetChatSchema` - Schema for widget chat input (message + optional conversationId)

3. **Extracted shared helper functions:**
   - `validateWidgetToken()` - Validates widget token and returns associated agent
   - `checkWidgetRateLimit()` - Checks tenant rate limit for chat requests
   - `setSSEHeaders()` - Sets required headers for SSE streaming
   - `handleWidgetChatStream()` - Unified streaming handler for widget chat

4. **Updated routes to use shared handler:**
   - `apps/api/src/routes/widget.ts` - Both `/chat` and `/chat/stream` now use `handleWidgetChatStream()`

5. **Added tests:**
   - `apps/api/src/services/widget-chat-helpers.test.ts` - 11 tests covering validation schema

### Code Reduction
- Eliminated ~50 lines of duplicate code between /chat and /chat/stream handlers
- Centralized SSE header configuration
- Token validation and rate limiting now use single implementations
- Routes reduced from 172 lines to 66 lines

### Files Changed
- `apps/api/src/services/widget-chat-helpers.ts` (NEW)
- `apps/api/src/services/widget-chat-helpers.test.ts` (NEW)
- `apps/api/src/routes/widget.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Create reusable agent ownership loader

### Completed Task
**Task:** Create reusable agent ownership loader for agents and tools routes
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/agent-helpers.ts`

2. **Extracted shared helper functions:**
   - `loadAgentForTenant()` - Load an agent and verify it belongs to the specified tenant; throws NotFoundError if not found
   - `tryLoadAgentForTenant()` - Same as above but returns null instead of throwing

3. **Exported types:**
   - `Agent` - Type alias for agent table row
   - `AgentOwnershipResult` - Return type for loadAgentForTenant

4. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/agents.ts` - Refactored 11 route handlers to use `loadAgentForTenant()`
   - `apps/api/src/routes/tools.ts` - Refactored 5 route handlers to use `loadAgentForTenant()`

5. **Added tests:**
   - `apps/api/src/services/agent-helpers.test.ts` - 10 tests covering module exports and function contracts

### Code Reduction
- Eliminated ~120 lines of duplicate agent ownership verification code
- Standardized error handling for agent not found scenarios
- Centralized the ownership check pattern into a single, well-documented function
- Routes now use a single function call instead of repeating the same 10-line pattern

### Files Changed
- `apps/api/src/services/agent-helpers.ts` (NEW)
- `apps/api/src/services/agent-helpers.test.ts` (NEW)
- `apps/api/src/routes/agents.ts` (MODIFIED)
- `apps/api/src/routes/tools.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Extract shared knowledge base aggregation utilities

### Completed Task
**Task:** Extract shared knowledge base aggregation utilities (counts, summaries)
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/kb-aggregation-helpers.ts`

2. **Extracted shared types:**
   - `KbCountResult` - Type for KB ID to count mapping
   - `KbAggregatedCounts` - Type for source and chunk counts
   - `KbAggregatedCountsWithShares` - Type including share counts for admin views

3. **Extracted grouped count functions (for KB lists):**
   - `getSourceCountsByKb()` - Get source counts grouped by KB ID
   - `getChunkCountsByKb()` - Get chunk counts grouped by KB ID
   - `getShareCountsByKb()` - Get subscription/share counts grouped by KB ID
   - `getKbCountMaps()` - Convenience function returning both source and chunk count maps
   - `getKbCountMapsWithShares()` - Returns source, chunk, and share count maps for admin views

4. **Extracted single KB count functions:**
   - `getKbSourceCount()` - Get source count for a single KB
   - `getKbChunkCount()` - Get chunk count for a single KB
   - `getKbAggregatedCounts()` - Get both source and chunk counts for a single KB

5. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/knowledge-bases.ts` - Tenant KB list route
   - `apps/api/src/routes/admin/shared-kbs.ts` - Admin global KB list and details routes

6. **Added tests:**
   - `apps/api/src/services/kb-aggregation-helpers.test.ts` - 16 tests covering module exports and type definitions

### Code Reduction
- Eliminated ~60 lines of duplicate aggregation code between knowledge-bases.ts and shared-kbs.ts
- Centralized source, chunk, and share count queries prevent drift between routes
- All aggregation queries now use efficient parallel execution via Promise.all
- Empty kbIds array is handled efficiently (returns empty Map without DB query)

### Files Changed
- `apps/api/src/services/kb-aggregation-helpers.ts` (NEW)
- `apps/api/src/services/kb-aggregation-helpers.test.ts` (NEW)
- `apps/api/src/routes/knowledge-bases.ts` (MODIFIED)
- `apps/api/src/routes/admin/shared-kbs.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Split auth middleware into focused modules

### Completed Task
**Task:** Split auth middleware into focused modules and re-export a unified middleware
**Status:** COMPLETED

### Changes Made

1. **Created new auth middleware module directory:**
   - `apps/api/src/middleware/auth/`

2. **Extracted focused modules:**
   - `types.ts` - Type definitions (AuthUser, AuthContext, RLSContext)
   - `helpers.ts` - Shared utilities (withRequestRLS, checkSystemAdmin, findOrCreateUser, resolveTenantContext)
   - `bearer.ts` - Local JWT bearer token authentication
   - `oidc.ts` - OIDC/external provider authentication
   - `api-key.ts` - Tenant-scoped API key authentication
   - `admin-token.ts` - System-level admin token authentication
   - `middleware.ts` - Main auth middleware and RBAC middleware (requireRole, requireSystemAdmin, requireTenant)
   - `index.ts` - Unified re-exports

3. **Updated auth.ts to re-export from modular structure:**
   - Original `apps/api/src/middleware/auth.ts` now re-exports all from `./auth/index`
   - Full backward compatibility maintained - no changes needed in route files

4. **Added tests:**
   - `apps/api/src/middleware/auth/auth.test.ts` - 36 tests covering all module exports and behavior

### Code Organization
- Split 522-line monolithic auth.ts into 8 focused modules
- Each authentication method is now in its own file for easier maintenance
- Shared helper functions extracted to reduce code duplication
- Types centralized in dedicated types.ts file
- Clear separation of concerns between authentication methods

### Files Changed
- `apps/api/src/middleware/auth/types.ts` (NEW)
- `apps/api/src/middleware/auth/helpers.ts` (NEW)
- `apps/api/src/middleware/auth/bearer.ts` (NEW)
- `apps/api/src/middleware/auth/oidc.ts` (NEW)
- `apps/api/src/middleware/auth/api-key.ts` (NEW)
- `apps/api/src/middleware/auth/admin-token.ts` (NEW)
- `apps/api/src/middleware/auth/middleware.ts` (NEW)
- `apps/api/src/middleware/auth/index.ts` (NEW)
- `apps/api/src/middleware/auth/auth.test.ts` (NEW)
- `apps/api/src/middleware/auth.ts` (MODIFIED - now re-exports from auth/)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Break up web API client into client/types/domain modules

### Completed Task
**Task:** Break up web API client into client/types/domain modules
**Status:** COMPLETED

### Changes Made

1. **Created new modular API client directory:**
   - `apps/web/src/lib/api/`

2. **Created client module:**
   - `client.ts` - Request helper, token/tenant management, API_BASE config

3. **Created types module:**
   - `types.ts` - All TypeScript interfaces organized by domain (User, Tenant, KnowledgeBase, Source, Agent, Chat, Tools, Admin, Analytics, Audit)

4. **Created domain-specific endpoint modules:**
   - `auth.ts` - Authentication endpoints (getMe, login, logout, register, getMyTenants)
   - `tenants.ts` - Tenant management endpoints (CRUD, members, alert settings, API keys)
   - `knowledge-bases.ts` - KB endpoints (CRUD, reindex operations)
   - `sources.ts` - Source endpoints (CRUD, runs, stats, file upload)
   - `agents.ts` - Agent endpoints (CRUD, widget config, retrieval config, chat endpoints)
   - `chat.ts` - Chat endpoints (chat, simpleChatStream with SSE)
   - `tools.ts` - Tool endpoints (CRUD, builtin tools, agent tool attachments)
   - `analytics.ts` - Analytics endpoints (getAnalytics)
   - `admin.ts` - Admin endpoints (settings, providers, models, users, shared KBs, dashboard, email, alerts, analytics, tokens, audit logs)

5. **Created unified re-export index:**
   - `index.ts` - Re-exports all client utilities, types, and domain APIs; assembles unified `api` object for backward compatibility

6. **Updated main api.ts for backward compatibility:**
   - `apps/web/src/lib/api.ts` - Now re-exports everything from `./api/index`

7. **Added tests:**
   - `apps/web/src/lib/api/api.test.ts` - 16 tests covering module exports, domain APIs, unified api object, and backward compatibility

### Code Organization
- Split 1,599-line monolithic api.ts into 11 focused modules
- Types organized by domain (Auth, Tenant, KB, Source, Agent, Chat, AI Provider, Admin, Analytics, Audit, Tools)
- Each domain has its own endpoint module for easier maintenance
- Unified `api` object preserves backward compatibility - no changes needed in consuming files
- Domain APIs also exported individually for direct use (e.g., `authApi`, `tenantsApi`)

### Files Changed
- `apps/web/src/lib/api/client.ts` (NEW)
- `apps/web/src/lib/api/types.ts` (NEW)
- `apps/web/src/lib/api/auth.ts` (NEW)
- `apps/web/src/lib/api/tenants.ts` (NEW)
- `apps/web/src/lib/api/knowledge-bases.ts` (NEW)
- `apps/web/src/lib/api/sources.ts` (NEW)
- `apps/web/src/lib/api/agents.ts` (NEW)
- `apps/web/src/lib/api/chat.ts` (NEW)
- `apps/web/src/lib/api/tools.ts` (NEW)
- `apps/web/src/lib/api/analytics.ts` (NEW)
- `apps/web/src/lib/api/admin.ts` (NEW)
- `apps/web/src/lib/api/index.ts` (NEW)
- `apps/web/src/lib/api/api.test.ts` (NEW)
- `apps/web/src/lib/api.ts` (MODIFIED - now re-exports from api/)
- `apps/web/package.json` (MODIFIED - added test script)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Move tenant alert validation/defaulting into a helper module

### Completed Task
**Task:** Move tenant alert validation/defaulting into a helper module
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/tenant-alert-helpers.ts`

2. **Extracted validation schema:**
   - `updateAlertSettingsSchema` - Zod schema for updating alert settings

3. **Extracted default constants:**
   - `DEFAULT_ALERT_SETTINGS` - Default values for alert settings (enabled, notifyOwners, etc.)

4. **Extracted types:**
   - `TenantAlertSettings` - Type for alert settings from database or defaults
   - `ResolvedAlertSettings` - Type with system defaults applied to null thresholds
   - `UpdateAlertSettingsInput` - Zod-inferred input type

5. **Extracted helper functions:**
   - `validateAdditionalEmails()` - Validates comma-separated email list
   - `parseAdditionalEmails()` - Parses email list into array
   - `getDefaultAlertSettings()` - Returns default settings for a tenant
   - `resolveAlertSettings()` - Merges tenant settings with system defaults
   - `buildAlertSettingsInsertValues()` - Builds insert data for upsert
   - `buildAlertSettingsUpdateValues()` - Builds update data for upsert

6. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/tenants.ts` - Alert settings routes

7. **Updated services to use shared helpers:**
   - `apps/api/src/services/health-alerts.ts` - Per-tenant alert processing

8. **Added tests:**
   - `apps/api/src/services/tenant-alert-helpers.test.ts` - 34 tests covering all schemas and helpers

### Code Reduction
- Eliminated ~40 lines of duplicate default value logic between tenants.ts and health-alerts.ts
- Centralized validation schema prevents drift between routes
- Alert settings resolution now uses a single implementation
- Email parsing and validation logic consolidated into reusable functions

### Files Changed
- `apps/api/src/services/tenant-alert-helpers.ts` (NEW)
- `apps/api/src/services/tenant-alert-helpers.test.ts` (NEW)
- `apps/api/src/routes/tenants.ts` (MODIFIED)
- `apps/api/src/services/health-alerts.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)
