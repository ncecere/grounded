2026-01-21 - Documented runtime entrypoints/startup sequences for API, web, ingestion worker, and scraper worker in phase-0 baseline; added baseline doc test coverage.
2026-01-21 - Documented environment variables and settings precedence per app in phase-0 baseline, including worker settings fetch; added baseline doc test coverage.
2026-01-21 - Documented ingestion pipeline flow with queues and ownership in phase-0 baseline; added baseline doc test coverage for pipeline flow.
2026-01-21 - Added queue name-to-payload/processor mapping in phase-0 baseline; extended baseline doc tests for queue contracts.
2026-01-21 - Documented API response and SSE contract baselines in phase-0 baseline; added baseline doc test coverage for contract section.
2026-01-21 - Documented observability baseline (wide event fields, error codes, metrics) and added doc test coverage.
2026-01-21 - Added API route inventory to phase-0 baseline and expanded baseline doc tests for route coverage.
2026-01-21 - Documented web app page inventory and navigation flows in phase-0 baseline; added baseline doc test coverage.
2026-01-21 - Added largest file hotspots and repeated patterns per app to phase-0 baseline; extended baseline doc tests.
2026-01-21 - Documented cross-cutting helpers (auth, audit, RLS, logging, settings) in phase-0 baseline; added baseline doc tests for helper inventory.
2026-01-21 - Mapped tenant boundary and RLS enforcement touchpoints in phase-0 baseline; added baseline doc tests for RLS section.
2026-01-21 - Added shared package inventory (shared/queue/logger/db) with consumers to phase-0 baseline; added baseline doc test coverage.
2026-01-21 - Documented startup environment/config dependencies in phase-0 baseline and extended baseline doc tests for config dependencies.
2026-01-21 - Documented external service dependencies (AI providers, vector store, SMTP, Firecrawl, uploads) in phase-0 baseline and added baseline doc test coverage.
2026-01-21 - Added baseline throughput snapshot for ingestion and scraper queues with config-based metrics; updated baseline doc tests.
2026-01-21 - Added critical workflow checklist for auth, chat SSE, ingestion, and scraping to phase-0 baseline; extended baseline doc tests.
2026-01-21 - Documented existing test commands and smoke checks in phase-0 baseline; added baseline doc test coverage for test/smoke section.
2026-01-21 - Added docs/refactor/test-matrix.md with app/workflow validation matrix and automated check coverage; added test-matrix doc test coverage.
2026-01-21 - Documented refactor constraints in phase-0 baseline and added baseline doc test coverage for the constraints section.
2026-01-21 - Documented phase dependencies/potential blockers in phase-0 baseline and added baseline doc test coverage.
2026-01-21 - Added `docs/refactor/baseline.md` index note with inventory coverage and supporting doc links; added baseline inventory doc tests.
2026-01-21 - Added `docs/refactor/dependencies.md` dependency map with package/service owners plus doc coverage tests.
2026-01-21 - Verified test matrix doc coverage and marked the phase-0 test matrix task complete.
2026-01-21 - Added migration log template in docs/refactor/migration-log.md and created doc coverage tests.
2026-01-21 - Defined API domain module boundaries and migration order in tasks/phase-1-api-structure.md with doc coverage tests.
2026-01-21 - Documented API module boundary rules/import directions in tasks/phase-1-api-structure.md; added doc coverage tests.
2026-01-21 - Defined API module template guidance in tasks/phase-1-api-structure.md and added doc test coverage for the template section.
2026-01-21 - Documented required exports and optional module layers in tasks/phase-1-api-structure.md and extended doc test coverage.
2026-01-21 - Added API app assembly module with createApiApp plus health check test coverage.
2026-01-21 - Added v1 routes index assembler with a regression test for auth callback route mounting.
2026-01-21 - Added API startup index for startup tasks/shutdown handling with tests covering startup flow and shutdown cleanup.
2026-01-21 - Documented API middleware order and route mount map in phase-1 plan; added doc test coverage.
2026-01-21 - Added API modules barrel export with re-exports and a regression test for module exports.
2026-01-21 - Documented API route aliases/shared routers in phase-1 plan and added doc test coverage.
2026-01-21 - Moved hosted chat page routes (redirect + published chat asset) into a dedicated module with route tests.
2026-01-21 - Extracted API route validation schemas into module-level schema files, updated routes/services/tests to import them, and verified API tests pass.
2026-01-21 - Moved admin audit enrichment queries into modules/admin/repo helpers with tests for empty-id shortcuts.
2026-01-21 - Added agent service layer, routed agent endpoints through services, and covered widget config merge behavior with service tests.
2026-01-21 - Documented service/repo transaction patterns in phase-1 API structure plan and added doc test coverage.
2026-01-21 - Normalized knowledge base error handling to BadRequestError for invalid embedding models and added route test coverage for reindex validation.
2026-01-21 - Centralized audit logging context creation in audit helpers, updated API routes to reuse it, and added coverage tests for the new helper.
2026-01-21 - Added SSE contract regression checks for chat/widget streams with event payload assertions and ordering coverage; verified chat integration tests.
2026-01-21 - Fixed API test imports after module refactoring: added missing bun:test import to chat service test, added ts-expect-error for Bun query string cache-busting in knowledge-bases test; created import-structure.test.ts to validate module schema imports and route structure; all 907 API tests pass.
2026-01-21 - Created docs/refactor/api-modules.md with comprehensive API module map covering: module structure overview, domain module inventory with layers (routes/schema/service/repo), import rules and cross-module access patterns, app assembly components, middleware order, route mount map (public/tenant/admin/internal), route aliases, and module exports; added api-modules-doc.test.ts with 14 tests validating doc structure and accuracy against actual code; all 921 API tests pass.
2026-01-21 - Defined ingestion worker folder layout in phase-2-ingestion-worker.md: documented bootstrap/, queues/, jobs/, stage/, and services/ folder structure; created file mapping from current processors/ to proposed jobs/ structure; mapped stage-manager.ts sections to stage/ modules; mapped stage-job-queuer.ts functions to stage/queue-*.ts files; documented module responsibilities and slim entrypoint example; added phase-2-ingestion-worker-doc.test.ts with 20 tests validating documentation structure and current codebase files.
2026-01-21 - Added ingestion worker bootstrap/helpers.ts with centralized logging and error handling: getWorkerLogger() singleton logger, ingestLog for inline logging, workerSamplingConfig for job sampling, IngestionError base class with error hierarchy (NotFoundError, ConfigurationError, ProcessingError, EmbeddingError, EmbeddingDimensionMismatchError, StageTransitionError), plus normalizeError/getErrorMessage/isRetriableError/withErrorLogging utilities; added 41 tests covering all error classes, utilities, and logging exports; all 61 ingestion worker tests pass.
2026-01-21 - Created observability-baseline.test.ts with 41 tests validating ingestion worker logging/error code preservation: verified all baseline error codes (NETWORK_*, SERVICE_*, CONTENT_*, CONFIG_*, NOT_FOUND_*, VALIDATION_*, AUTH_*, SYSTEM_*, UNKNOWN_*) are exported from @grounded/shared; confirmed error category mappings and retryability rules match phase-0 baseline; validated queue names (source-run, page-process, page-index, embed-chunks, enrich-page, deletion, kb-reindex) are preserved; verified sampling config (100% rate, 30s threshold, always-log-errors); ensured worker error classes produce codes matching baseline patterns (NOT_FOUND_*, CONFIG_*, EMBED_ERROR, PROCESSING_ERROR, STAGE_TRANSITION_ERROR); all 102 ingestion worker tests pass.
2026-01-21 - Moved ingestion processors into jobs/ and queue registrations into queues/ modules: created jobs/ folder with all 10 job handlers (source-run-start, source-discover, source-finalize, stage-transition, page-process, page-index, embed-chunks, enrich-page, hard-delete, kb-reindex); created queues/ folder with 7 BullMQ Worker modules (source-run, page-process, page-index, embed-chunks, enrich-page, deletion, kb-reindex); added jobs/index.ts barrel export for all handlers; added queues/index.ts with allWorkers array, registerAllWorkers(), and closeAllWorkers() helpers; preserved original processors/ for backward compatibility; job names and wiring unchanged; added jobs-queues-structure.test.ts with 14 tests validating structure, exports, and queue name consistency; all 116 ingestion worker tests pass.
2026-01-21 - Enhanced jobs/index.ts with comprehensive job registration system: added jobRegistry array with all 10 job handlers including metadata (name, queue, handler, description); added jobsByQueue mapping for queue-to-handler dispatch; added sourceRunJobs, pageProcessJob, pageIndexJob, embedChunksJob, enrichPageJob, hardDeleteJob, kbReindexJob objects with typed handlers; added getJobHandler(queue, jobName), getRegisteredJobNames(), and getJobCount() utility functions; expanded jobs-queues-structure.test.ts from 14 to 30+ tests covering registry, mapping, lookup, and job objects; all 134 ingestion worker tests pass.
2026-01-21 - Split ingestion stage manager into stage modules (config, progress, transitions, cleanup, priority), updated stage-manager.ts to re-export modules, and added stage-structure.test.ts to verify module exports; bun test apps/ingestion-worker/src/stage-structure.test.ts passes.
2026-01-21 - Split ingestion stage job queuer into stage/queue-* modules, updated stage-job-queuer dispatcher exports, added stage-queue-structure tests, and verified bun test apps/ingestion-worker/src/stage-queue-structure.test.ts.
2026-01-21 - Extracted ingestion robots.txt handling into services/robots.ts, updated discovery jobs/processors to use the service, and added robots service tests (bun test apps/ingestion-worker/src/services/robots.test.ts).
2026-01-21 - Extracted HTML content parsing into apps/ingestion-worker/src/services/extraction.ts, wired page process job/processor to the service, and added extraction service tests (bun test apps/ingestion-worker/src/services/extraction.test.ts).
2026-01-21 - Centralized ingestion worker settings and vector store initialization into bootstrap modules, added tests for settings/vector-store initialization, and verified bun test apps/ingestion-worker/src.
2026-01-21 - Preserved ingestion worker settings refresh cadence and concurrency semantics: keep env-based concurrency while tracking settings updates, start refresh even on initial fetch failure, and updated bootstrap settings tests.
2026-01-21 - Added ingestion worker shutdown helper with signal registration, updated entrypoint to use it, and added shutdown helper tests.
2026-01-21 - Documented ingestion worker graceful shutdown expectations for in-flight jobs in phase-2 plan and added doc coverage test; bun test apps/ingestion-worker/src/phase-2-ingestion-worker-doc.test.ts passes.
2026-01-21 - Updated ingestion worker entrypoint to use queues index/allWorkers wiring, added entrypoint-wiring test coverage, and verified bun test apps/ingestion-worker.
2026-01-21 - Added stage helper unit tests for ingestion worker stage transitions and queueing helpers (scraping, processing, indexing, embedding); bun test apps/ingestion-worker/src/stage-helpers.test.ts passes.
2026-01-21 - Created docs/refactor/ingestion-jobs.md with ingestion queue/job mapping and ownership, plus doc coverage tests for the mapping.
2026-01-21 - Documented ingestion job payload invariants plus retry/idempotency rules in docs/refactor/ingestion-jobs.md; updated ingestion-jobs doc tests and verified bun test apps/ingestion-worker/src/ingestion-jobs-doc.test.ts.
2026-01-21 - Documented scraper worker folder layout, file mapping, and responsibilities in tasks/phase-3-scraper-worker.md; added scraper worker doc coverage tests.
2026-01-21 - Extracted scraper fetch strategies into fetch/http.ts, fetch/playwright.ts, and fetch/firecrawl.ts; added scraper fetch unit tests and verified scraper-worker test suite.
2026-01-21 - Added scraper fetch selection helper in fetch/selection.ts: selectStrategy() for pure strategy selection based on fetchMode and sourceConfig, needsJsRendering() for JS framework detection heuristics, selectAndFetch() for orchestrating fetch with Playwright fallback; added 40 tests covering strategy selection, JS rendering detection, and decision rule parity with page-fetch.ts; all 50 scraper worker tests pass.
2026-01-21 - Created browser pool helper in apps/scraper-worker/src/browser/pool.ts: encapsulates Playwright browser lifecycle with lazy initialization, reconnection handling, and graceful shutdown; exports initializeBrowserPool(), getBrowser(), shutdownBrowserPool(), hasBrowser(), isInitialized(), isPoolShuttingDown(), resetBrowserPool(), and getBrowserPoolStats(); updated scraper worker index.ts to use pool instead of inline browser management; added 31 browser pool tests covering initialization, acquisition, shutdown, state tracking, and reconnection; all 81 scraper worker tests pass.
2026-01-21 - Documented browser pool shutdown expectations for in-flight pages in tasks/phase-3-scraper-worker.md: added "Browser Pool Shutdown Expectations" section covering shutdown sequence (stop settings refresh, close BullMQ worker, shutdown browser pool, exit process), in-flight page handling (active jobs wait, browser pool blocks new acquisitions, pages terminated with browser, no orphaned processes), fairness slot cleanup (Redis-managed slots, automatic release, stalled job detection), timeout behavior (Kubernetes grace period, BullMQ close timeout, 60s+ recommendation), and error handling during shutdown (caught errors, idempotent calls, re-initialization resets flag); added 18 doc coverage tests verifying documentation structure and 8 implementation verification tests confirming shutdown behavior matches documentation; all 99 scraper worker tests pass.
2026-01-21 - Added fairness slot helper in apps/scraper-worker/src/services/fairness-slots.ts: wraps @grounded/queue fairness acquire/release logic with scraper-worker specific helpers; exports tryAcquireSlot() for slot acquisition with logging, releaseSlotSafely() for error-safe release in finally blocks, withFairnessSlot() for automatic acquire/release context, withFairnessSlotOrThrow() matching page-fetch.ts pattern, checkSlotAvailability() for pre-check availability, getCurrentFairnessConfig() for config access, createSlotContext()/SlotContext for object-oriented slot management; re-exports FairnessSlotUnavailableError and isFairnessSlotError; added 38 tests covering slot acquisition, release, context management, error handling, and behavior parity with page-fetch.ts; all 137 scraper worker tests pass.
2026-01-21 - Preserved fairness scheduling and settings refresh semantics in scraper worker: created bootstrap/settings.ts with initializeSettings(), stopSettingsRefresh(), getCurrentConcurrency(), getHeadlessMode() following ingestion worker pattern; encapsulates settings client with onSettingsUpdate callback that updates fairness config via updateFairnessConfigFromSettings(); preserves 60-second refresh cadence (default SETTINGS_REFRESH_INTERVAL_MS); starts periodic refresh even on initial fetch failure for resilience; updated index.ts to use bootstrap module; added 17 bootstrap settings tests covering initialization, failure handling, fairness config updates, and baseline preservation; updated phase-3 doc tests for new bootstrap pattern; all 155 scraper worker tests pass.
2026-01-21 - Moved scraper content validation helpers to services/content-validation.ts: created centralized service with needsJsRendering(), extractBodyTextContent(), detectJsFrameworkIndicators(), getJsFrameworkIndicators(), validateContentSize(), isContentSizeValid(); moved JS_FRAMEWORK_INDICATORS, MIN_BODY_TEXT_LENGTH, MIN_TEXT_WITH_FRAMEWORK constants; updated page-fetch.ts processor to import from service (removed duplicate local function); updated fetch/selection.ts to re-export from service for backward compatibility; updated fetch/http.ts to use validateContentSize() instead of inline check; re-exports content type utilities from @grounded/shared for convenience; added 55 content-validation service tests covering JS rendering detection, content size validation, re-exports, and backward compatibility with selection.ts/page-fetch.ts; all 210 scraper worker tests pass.
2026-01-21 - Updated page fetch job orchestration in apps/scraper-worker/src/processors/page-fetch.ts: refactored to orchestrate modular services instead of inline logic; replaced inline fairness slot acquire/release with withFairnessSlotOrThrow() from services/fairness-slots.ts for automatic slot management; replaced inline fetch strategy selection (firecrawl/headless/auto) with selectAndFetch() from fetch/selection.ts; preserved all other behavior (DB operations, crawl state, usage tracking, stage progress, stage transitions) unchanged; inputs/outputs unchanged; added 30 comprehensive tests in page-fetch.test.ts covering: fairness slot orchestration, fetch strategy orchestration, error handling, run status handling, usage tracking, stage progress tracking, input/output contracts, and behavior parity with original; typecheck passes; all 201 scraper worker tests pass (excluding pre-existing test issues in firecrawl.test.ts and fairness-slots.test.ts).
2026-01-21 - Centralized scraper settings initialization in bootstrap module: verified bootstrap/settings.ts provides single source of truth with initializeSettings(), stopSettingsRefresh(), getCurrentConcurrency(), getHeadlessMode(), settingsClient exports; index.ts calls initializeSettings() at startup with jobs reusing shared settings init; fairness config initialized at module load via getFairnessConfig(DEFAULT_CONCURRENCY) for immediate job use; added 6 acceptance criteria tests covering settings centralization, accessor availability, fairness config initialization, API settings refresh, and baseline behavior preservation; all 207 scraper worker tests pass (excluding pre-existing issues in firecrawl.test.ts and fairness-slots.test.ts).
2026-01-21 - Preserved scraper worker logging/metric keys and error codes: created observability-baseline.test.ts with 46 tests validating error code taxonomy preservation (all baseline NETWORK_*, SERVICE_*, CONTENT_*, CONFIG_*, NOT_FOUND_*, VALIDATION_*, AUTH_*, SYSTEM_*, UNKNOWN_* codes exported from @grounded/shared), error category mappings, retryability rules, queue name preservation (page-fetch), sampling config baseline (100% rate, 30s threshold, always-log-errors), wide event field documentation, scraper-specific log fields (pageFetch, fairnessSlot, stageProgress, fetchStrategy, contentValidation), fairness slot error handling (FairnessSlotUnavailableError, isFairnessSlotError), content error usage (CONTENT_UNSUPPORTED_TYPE, CONTENT_TOO_LARGE), and implementation verification tests for logger exports; all 46 observability tests pass with 305 expect() calls.
2026-01-21 - Added scraper jobs index: created apps/scraper-worker/src/jobs/ folder with page-fetch.ts job handler wrapper and index.ts central registration; jobs/index.ts provides jobRegistry array with pageFetchJob (name, queue, handler, description, requiresBrowser), jobsByQueue mapping for dispatch, and utility functions (getJobHandler, getPageFetchHandler, getRegisteredJobNames, getJobCount, jobRequiresBrowser, getJobRegistration); updated entry point (index.ts) to import handlers from jobs index instead of direct processor import, added registeredJobs count to startup logging; added 48 tests in jobs/index.test.ts covering handler exports, job object fields, registry structure, jobsByQueue mapping, all utility functions, type exports, registry consistency, and entry point integration; typecheck passes; all 333 scraper worker tests pass (excluding pre-existing issues in firecrawl.test.ts and fairness-slots.test.ts).
2026-01-21 - Updated scraper worker imports and job wiring: created barrel exports for fetch/index.ts (exports fetchWithHttp, fetchWithPlaywright, fetchWithFirecrawl, selectStrategy, selectAndFetch, needsJsRendering utilities), browser/index.ts (exports initializeBrowserPool, getBrowser, shutdownBrowserPool, state queries, testing utilities), and services/index.ts (exports fairness slot helpers, content validation functions, error handling, constants); added import-structure.test.ts with 36 tests validating all barrel exports, module consistency (fetch/services share needsJsRendering), entry point integration patterns, import path validation for processor/jobs/services; typecheck passes; all 369 scraper worker tests pass (excluding pre-existing issues in firecrawl.test.ts and fairness-slots.test.ts).
