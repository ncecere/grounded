# Grounded Refactoring Progress

## 2026-01-17: Extract shared source CRUD + run helpers

### Completed Task
**Task:** Extract shared source CRUD + run helpers for sources and shared-kbs routes
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/source-helpers.ts`

2. **Extracted shared validation schemas:**
   - `createSourceBaseSchema` - Base schema for source creation
   - `createSourceWithKbIdSchema` - Schema with kbId for tenant sources
   - `updateSourceSchema` - Schema for partial source updates
   - `triggerRunSchema` - Schema for run trigger options

3. **Extracted shared helper functions:**
   - `buildSourceUpdateData()` - Merges partial config updates with existing config
   - `calculateSourceStats()` - Computes page count and chunk count for a source
   - `cascadeSoftDeleteSourceChunks()` - Soft-deletes all chunks for a source
   - `findRunningRun()` - Checks if a source has an active run
   - `createSourceRun()` - Creates a new source run record
   - `queueSourceRunJob()` - Queues a source run job for processing

4. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/sources.ts` - Tenant source routes
   - `apps/api/src/routes/admin/shared-kbs.ts` - Global KB source routes

5. **Added tests:**
   - `apps/api/src/services/source-helpers.test.ts` - 23 tests covering all schemas and helpers

### Code Reduction
- Eliminated ~100 lines of duplicate code between sources.ts and shared-kbs.ts
- Centralized validation schemas prevent drift between routes
- Stats calculation, cascade delete, and run management now use single implementations

### Files Changed
- `apps/api/src/services/source-helpers.ts` (NEW)
- `apps/api/src/services/source-helpers.test.ts` (NEW)
- `apps/api/src/routes/sources.ts` (MODIFIED)
- `apps/api/src/routes/admin/shared-kbs.ts` (MODIFIED)
- `apps/api/package.json` (MODIFIED - added test script)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Unify widget /chat and /chat/stream handlers

### Completed Task
**Task:** Unify widget /chat and /chat/stream handlers into a shared streaming function
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/widget-chat-helpers.ts`

2. **Extracted shared validation schema:**
   - `widgetChatSchema` - Schema for widget chat input (message + optional conversationId)

3. **Extracted shared helper functions:**
   - `validateWidgetToken()` - Validates widget token and returns associated agent
   - `checkWidgetRateLimit()` - Checks tenant rate limit for chat requests
   - `setSSEHeaders()` - Sets required headers for SSE streaming
   - `handleWidgetChatStream()` - Unified streaming handler for widget chat

4. **Updated routes to use shared handler:**
   - `apps/api/src/routes/widget.ts` - Both `/chat` and `/chat/stream` now use `handleWidgetChatStream()`

5. **Added tests:**
   - `apps/api/src/services/widget-chat-helpers.test.ts` - 11 tests covering validation schema

### Code Reduction
- Eliminated ~50 lines of duplicate code between /chat and /chat/stream handlers
- Centralized SSE header configuration
- Token validation and rate limiting now use single implementations
- Routes reduced from 172 lines to 66 lines

### Files Changed
- `apps/api/src/services/widget-chat-helpers.ts` (NEW)
- `apps/api/src/services/widget-chat-helpers.test.ts` (NEW)
- `apps/api/src/routes/widget.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Create reusable agent ownership loader

### Completed Task
**Task:** Create reusable agent ownership loader for agents and tools routes
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/agent-helpers.ts`

2. **Extracted shared helper functions:**
   - `loadAgentForTenant()` - Load an agent and verify it belongs to the specified tenant; throws NotFoundError if not found
   - `tryLoadAgentForTenant()` - Same as above but returns null instead of throwing

3. **Exported types:**
   - `Agent` - Type alias for agent table row
   - `AgentOwnershipResult` - Return type for loadAgentForTenant

4. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/agents.ts` - Refactored 11 route handlers to use `loadAgentForTenant()`
   - `apps/api/src/routes/tools.ts` - Refactored 5 route handlers to use `loadAgentForTenant()`

5. **Added tests:**
   - `apps/api/src/services/agent-helpers.test.ts` - 10 tests covering module exports and function contracts

### Code Reduction
- Eliminated ~120 lines of duplicate agent ownership verification code
- Standardized error handling for agent not found scenarios
- Centralized the ownership check pattern into a single, well-documented function
- Routes now use a single function call instead of repeating the same 10-line pattern

### Files Changed
- `apps/api/src/services/agent-helpers.ts` (NEW)
- `apps/api/src/services/agent-helpers.test.ts` (NEW)
- `apps/api/src/routes/agents.ts` (MODIFIED)
- `apps/api/src/routes/tools.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Extract shared knowledge base aggregation utilities

### Completed Task
**Task:** Extract shared knowledge base aggregation utilities (counts, summaries)
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/kb-aggregation-helpers.ts`

2. **Extracted shared types:**
   - `KbCountResult` - Type for KB ID to count mapping
   - `KbAggregatedCounts` - Type for source and chunk counts
   - `KbAggregatedCountsWithShares` - Type including share counts for admin views

3. **Extracted grouped count functions (for KB lists):**
   - `getSourceCountsByKb()` - Get source counts grouped by KB ID
   - `getChunkCountsByKb()` - Get chunk counts grouped by KB ID
   - `getShareCountsByKb()` - Get subscription/share counts grouped by KB ID
   - `getKbCountMaps()` - Convenience function returning both source and chunk count maps
   - `getKbCountMapsWithShares()` - Returns source, chunk, and share count maps for admin views

4. **Extracted single KB count functions:**
   - `getKbSourceCount()` - Get source count for a single KB
   - `getKbChunkCount()` - Get chunk count for a single KB
   - `getKbAggregatedCounts()` - Get both source and chunk counts for a single KB

5. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/knowledge-bases.ts` - Tenant KB list route
   - `apps/api/src/routes/admin/shared-kbs.ts` - Admin global KB list and details routes

6. **Added tests:**
   - `apps/api/src/services/kb-aggregation-helpers.test.ts` - 16 tests covering module exports and type definitions

### Code Reduction
- Eliminated ~60 lines of duplicate aggregation code between knowledge-bases.ts and shared-kbs.ts
- Centralized source, chunk, and share count queries prevent drift between routes
- All aggregation queries now use efficient parallel execution via Promise.all
- Empty kbIds array is handled efficiently (returns empty Map without DB query)

### Files Changed
- `apps/api/src/services/kb-aggregation-helpers.ts` (NEW)
- `apps/api/src/services/kb-aggregation-helpers.test.ts` (NEW)
- `apps/api/src/routes/knowledge-bases.ts` (MODIFIED)
- `apps/api/src/routes/admin/shared-kbs.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Split auth middleware into focused modules

### Completed Task
**Task:** Split auth middleware into focused modules and re-export a unified middleware
**Status:** COMPLETED

### Changes Made

1. **Created new auth middleware module directory:**
   - `apps/api/src/middleware/auth/`

2. **Extracted focused modules:**
   - `types.ts` - Type definitions (AuthUser, AuthContext, RLSContext)
   - `helpers.ts` - Shared utilities (withRequestRLS, checkSystemAdmin, findOrCreateUser, resolveTenantContext)
   - `bearer.ts` - Local JWT bearer token authentication
   - `oidc.ts` - OIDC/external provider authentication
   - `api-key.ts` - Tenant-scoped API key authentication
   - `admin-token.ts` - System-level admin token authentication
   - `middleware.ts` - Main auth middleware and RBAC middleware (requireRole, requireSystemAdmin, requireTenant)
   - `index.ts` - Unified re-exports

3. **Updated auth.ts to re-export from modular structure:**
   - Original `apps/api/src/middleware/auth.ts` now re-exports all from `./auth/index`
   - Full backward compatibility maintained - no changes needed in route files

4. **Added tests:**
   - `apps/api/src/middleware/auth/auth.test.ts` - 36 tests covering all module exports and behavior

### Code Organization
- Split 522-line monolithic auth.ts into 8 focused modules
- Each authentication method is now in its own file for easier maintenance
- Shared helper functions extracted to reduce code duplication
- Types centralized in dedicated types.ts file
- Clear separation of concerns between authentication methods

### Files Changed
- `apps/api/src/middleware/auth/types.ts` (NEW)
- `apps/api/src/middleware/auth/helpers.ts` (NEW)
- `apps/api/src/middleware/auth/bearer.ts` (NEW)
- `apps/api/src/middleware/auth/oidc.ts` (NEW)
- `apps/api/src/middleware/auth/api-key.ts` (NEW)
- `apps/api/src/middleware/auth/admin-token.ts` (NEW)
- `apps/api/src/middleware/auth/middleware.ts` (NEW)
- `apps/api/src/middleware/auth/index.ts` (NEW)
- `apps/api/src/middleware/auth/auth.test.ts` (NEW)
- `apps/api/src/middleware/auth.ts` (MODIFIED - now re-exports from auth/)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Break up web API client into client/types/domain modules

### Completed Task
**Task:** Break up web API client into client/types/domain modules
**Status:** COMPLETED

### Changes Made

1. **Created new modular API client directory:**
   - `apps/web/src/lib/api/`

2. **Created client module:**
   - `client.ts` - Request helper, token/tenant management, API_BASE config

3. **Created types module:**
   - `types.ts` - All TypeScript interfaces organized by domain (User, Tenant, KnowledgeBase, Source, Agent, Chat, Tools, Admin, Analytics, Audit)

4. **Created domain-specific endpoint modules:**
   - `auth.ts` - Authentication endpoints (getMe, login, logout, register, getMyTenants)
   - `tenants.ts` - Tenant management endpoints (CRUD, members, alert settings, API keys)
   - `knowledge-bases.ts` - KB endpoints (CRUD, reindex operations)
   - `sources.ts` - Source endpoints (CRUD, runs, stats, file upload)
   - `agents.ts` - Agent endpoints (CRUD, widget config, retrieval config, chat endpoints)
   - `chat.ts` - Chat endpoints (chat, simpleChatStream with SSE)
   - `tools.ts` - Tool endpoints (CRUD, builtin tools, agent tool attachments)
   - `analytics.ts` - Analytics endpoints (getAnalytics)
   - `admin.ts` - Admin endpoints (settings, providers, models, users, shared KBs, dashboard, email, alerts, analytics, tokens, audit logs)

5. **Created unified re-export index:**
   - `index.ts` - Re-exports all client utilities, types, and domain APIs; assembles unified `api` object for backward compatibility

6. **Updated main api.ts for backward compatibility:**
   - `apps/web/src/lib/api.ts` - Now re-exports everything from `./api/index`

7. **Added tests:**
   - `apps/web/src/lib/api/api.test.ts` - 16 tests covering module exports, domain APIs, unified api object, and backward compatibility

### Code Organization
- Split 1,599-line monolithic api.ts into 11 focused modules
- Types organized by domain (Auth, Tenant, KB, Source, Agent, Chat, AI Provider, Admin, Analytics, Audit, Tools)
- Each domain has its own endpoint module for easier maintenance
- Unified `api` object preserves backward compatibility - no changes needed in consuming files
- Domain APIs also exported individually for direct use (e.g., `authApi`, `tenantsApi`)

### Files Changed
- `apps/web/src/lib/api/client.ts` (NEW)
- `apps/web/src/lib/api/types.ts` (NEW)
- `apps/web/src/lib/api/auth.ts` (NEW)
- `apps/web/src/lib/api/tenants.ts` (NEW)
- `apps/web/src/lib/api/knowledge-bases.ts` (NEW)
- `apps/web/src/lib/api/sources.ts` (NEW)
- `apps/web/src/lib/api/agents.ts` (NEW)
- `apps/web/src/lib/api/chat.ts` (NEW)
- `apps/web/src/lib/api/tools.ts` (NEW)
- `apps/web/src/lib/api/analytics.ts` (NEW)
- `apps/web/src/lib/api/admin.ts` (NEW)
- `apps/web/src/lib/api/index.ts` (NEW)
- `apps/web/src/lib/api/api.test.ts` (NEW)
- `apps/web/src/lib/api.ts` (MODIFIED - now re-exports from api/)
- `apps/web/package.json` (MODIFIED - added test script)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Move tenant alert validation/defaulting into a helper module

### Completed Task
**Task:** Move tenant alert validation/defaulting into a helper module
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/tenant-alert-helpers.ts`

2. **Extracted validation schema:**
   - `updateAlertSettingsSchema` - Zod schema for updating alert settings

3. **Extracted default constants:**
   - `DEFAULT_ALERT_SETTINGS` - Default values for alert settings (enabled, notifyOwners, etc.)

4. **Extracted types:**
   - `TenantAlertSettings` - Type for alert settings from database or defaults
   - `ResolvedAlertSettings` - Type with system defaults applied to null thresholds
   - `UpdateAlertSettingsInput` - Zod-inferred input type

5. **Extracted helper functions:**
   - `validateAdditionalEmails()` - Validates comma-separated email list
   - `parseAdditionalEmails()` - Parses email list into array
   - `getDefaultAlertSettings()` - Returns default settings for a tenant
   - `resolveAlertSettings()` - Merges tenant settings with system defaults
   - `buildAlertSettingsInsertValues()` - Builds insert data for upsert
   - `buildAlertSettingsUpdateValues()` - Builds update data for upsert

6. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/tenants.ts` - Alert settings routes

7. **Updated services to use shared helpers:**
   - `apps/api/src/services/health-alerts.ts` - Per-tenant alert processing

8. **Added tests:**
   - `apps/api/src/services/tenant-alert-helpers.test.ts` - 34 tests covering all schemas and helpers

### Code Reduction
- Eliminated ~40 lines of duplicate default value logic between tenants.ts and health-alerts.ts
- Centralized validation schema prevents drift between routes
- Alert settings resolution now uses a single implementation
- Email parsing and validation logic consolidated into reusable functions

### Files Changed
- `apps/api/src/services/tenant-alert-helpers.ts` (NEW)
- `apps/api/src/services/tenant-alert-helpers.test.ts` (NEW)
- `apps/api/src/routes/tenants.ts` (MODIFIED)
- `apps/api/src/services/health-alerts.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 1 - Schema & Types for Advanced RAG

### Completed Tasks
**Phase:** Phase 1 - Schema & Types
**Status:** COMPLETED (All 7 tasks in parallel group 1)

### Changes Made

1. **Database Schema Changes:**
   - Added `rag_type` column to `agents` table (text, default "simple", values: simple|advanced)
   - Added `history_turns` column to `retrieval_configs` table (integer, default 5, range 1-20)
   - Added `advanced_max_subqueries` column to `retrieval_configs` table (integer, default 3, range 1-5)
   - Created migration file: `migrations/0020_advanced_rag_schema.sql`

2. **Shared Types (packages/shared):**
   - Added `RagType` enum with values `SIMPLE` and `ADVANCED`
   - Updated `Agent` interface to include `ragType: RagType`
   - Updated `retrievalConfigSchema` to include `historyTurns` and `advancedMaxSubqueries`

3. **Web API Types (apps/web/src/lib/api/types.ts):**
   - Added `RagType` type alias
   - Updated `Agent` interface to include `ragType`
   - Updated `retrievalConfig` type to include `historyTurns` and `advancedMaxSubqueries`

4. **Web Component Types (apps/web/src/components/agents/types.ts):**
   - Updated `AgentFormData` to include `ragType`
   - Updated `RetrievalConfig` to include `historyTurns` and `advancedMaxSubqueries`
   - Updated `defaultAgentForm` with `ragType: "simple"`
   - Updated `defaultRetrievalConfig` with `historyTurns: 5` and `advancedMaxSubqueries: 3`

5. **API Zod Schemas (apps/api/src/routes/agents.ts):**
   - Updated `createAgentSchema` with `ragType` field (enum, default "simple")
   - Updated `updateAgentSchema` with optional `ragType` field
   - Updated `updateRetrievalConfigSchema` with `historyTurns` and `advancedMaxSubqueries`
   - Updated agent creation to include `ragType` in insert values

6. **AgentFormModal Component:**
   - Updated form data population to include `ragType`
   - Updated retrieval config fetching to include `historyTurns` and `advancedMaxSubqueries`

7. **Tests:**
   - Created `apps/api/src/routes/agents.test.ts` with 39 tests covering:
     - `createAgentSchema` ragType defaults and validation
     - `updateAgentSchema` ragType optional updates
     - `updateRetrievalConfigSchema` historyTurns and advancedMaxSubqueries validation
     - Combined field validation

### Test Results
- All 185 tests pass across 8 test files
- All typecheck passes across 14 packages

### Files Changed
- `packages/db/src/schema/agents.ts` (MODIFIED - added ragType, historyTurns, advancedMaxSubqueries)
- `migrations/0020_advanced_rag_schema.sql` (NEW)
- `packages/shared/src/types/index.ts` (MODIFIED - added RagType, updated schemas)
- `apps/web/src/lib/api/types.ts` (MODIFIED - added RagType, updated Agent/retrievalConfig)
- `apps/web/src/components/agents/types.ts` (MODIFIED - updated form and config types)
- `apps/api/src/routes/agents.ts` (MODIFIED - updated schemas and creation)
- `apps/web/src/components/agents/AgentFormModal.tsx` (MODIFIED - include new fields)
- `apps/api/src/routes/agents.test.ts` (NEW - 39 tests)
- `Tasks/tasks.yml` (MODIFIED - marked Phase 1 tasks complete)

## 2026-01-17: Phase 2 - Create AdvancedRAGService file structure

### Completed Task
**Task:** Create AdvancedRAGService file structure
**Phase:** Phase 2 - Advanced RAG Service
**Status:** COMPLETED

### Changes Made

1. **Created AdvancedRAGService module:**
   - `apps/api/src/services/advanced-rag.ts`

2. **Implemented types and interfaces:**
   - `ReasoningStep` - Represents a single step in the reasoning process (rewrite, plan, search, merge, generate)
   - `SubQuery` - A sub-query generated from the multi-step plan
   - `AdvancedStreamEvent` - Extended stream events including reasoning step events
   - `AdvancedAgentConfig` - Configuration including historyTurns and advancedMaxSubqueries

3. **Implemented AdvancedRAGService class:**
   - Constructor with tenantId, agentId, and optional channel parameter
   - `chat()` async generator method for streaming responses with reasoning steps
   - `loadConfig()` - Load agent and retrieval config including advanced RAG settings
   - `rewriteQuery()` - Rewrite user query using conversation history context
   - `generateSubQueries()` - Generate focused sub-queries for comprehensive search
   - `executeSubQueries()` - Execute all sub-queries in parallel
   - `mergeAndDeduplicateChunks()` - Merge and deduplicate chunks by ID, keeping highest scores
   - `searchKnowledge()` - Search knowledge bases (reused pattern from SimpleRAGService)
   - `buildSystemPrompt()` - Build system prompt with retrieved context
   - `buildMessages()` - Build messages array from conversation history
   - `logUsage()` - Log usage to chat_events for analytics

4. **Reasoning step types implemented:**
   - `rewrite` - Query rewriting with conversation context
   - `plan` - Multi-step plan generation (sub-queries)
   - `search` - Knowledge base search
   - `merge` - Result merging and deduplication
   - `generate` - Final answer generation

5. **Stream event types:**
   - `status` - Status updates with optional source count
   - `reasoning` - Reasoning step progress (NEW for advanced mode)
   - `text` - Streamed response text
   - `sources` - Retrieved sources
   - `done` - Completion with conversation ID
   - `error` - Error message

6. **Added tests:**
   - `apps/api/src/services/advanced-rag.test.ts` - 24 tests covering:
     - Module exports (AdvancedRAGService class and types)
     - Constructor behavior (tenantId, agentId, channel parameters)
     - Chat method contract (AsyncGenerator, parameters)
     - ReasoningStep interface (type, status, optional details)
     - SubQuery interface (id, query, purpose)
     - AdvancedStreamEvent types (all 6 event types)
     - Service behavior contracts (step sequence, status transitions, channels)
     - Configuration defaults (historyTurns, advancedMaxSubqueries, etc.)
     - Event type discrimination
     - Comparison with SimpleRAGService

### Test Results
- All 225 tests pass (209 in api, 16 in web)
- All typecheck passes across 14 packages

### Files Changed
- `apps/api/src/services/advanced-rag.ts` (NEW - 460 lines)
- `apps/api/src/services/advanced-rag.test.ts` (NEW - 24 tests)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 2 - Implement query rewriting with conversation history

### Completed Task
**Task:** Implement query rewriting with conversation history
**Phase:** Phase 2 - Advanced RAG Service
**Status:** COMPLETED

### Changes Made

1. **Query rewriting implementation (already in advanced-rag.ts from Phase 2 file structure):**
   - `rewriteQuery()` method that uses LLM to reformulate queries with conversation context
   - Returns original query when no history is present (optimization)
   - Uses conversation history formatted as "User: ..." / "Assistant: ..." pairs
   - Includes comprehensive prompt with 5 rules for query rewriting
   - Handles errors gracefully by returning original query

2. **History management:**
   - Uses `historyTurns` config parameter to limit conversation context
   - Each turn = user + assistant message pair
   - Default of 5 turns = last 10 messages
   - Applies limit via `fullHistory.slice(-historyTurns * 2)`

3. **Added comprehensive tests for query rewriting behavior:**
   - History formatting tests (User/Assistant prefixes, newline joining)
   - Rewrite prompt structure validation
   - Expected rewriting scenario documentation:
     - No history returns original query
     - Self-contained queries may not need rewriting
     - Queries with pronouns need context expansion
     - Follow-up questions need expansion
   - History turns limiting tests
   - Error handling behavior documentation

### Test Results
- All 238 tests pass (222 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 17 new tests for query rewriting behavior

### Files Changed
- `apps/api/src/services/advanced-rag.test.ts` (MODIFIED - added 17 tests for query rewriting)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 2 - Implement multi-step plan generation

### Completed Task
**Task:** Implement multi-step plan generation
**Phase:** Phase 2 - Advanced RAG Service
**Status:** COMPLETED

### Changes Made

1. **Multi-step plan generation implementation (already in advanced-rag.ts from Phase 2 file structure):**
   - `generateSubQueries()` method that uses LLM to generate focused sub-queries
   - Returns single sub-query with original query when no config or model available (fallback)
   - Uses `advancedMaxSubqueries` config parameter to limit number of sub-queries
   - Includes comprehensive prompt with 6 rules for sub-query generation
   - Handles errors gracefully by returning original query as single sub-query

2. **Sub-query generation rules:**
   - Each sub-query should target a specific aspect of the original query
   - Sub-queries should be complementary, not redundant
   - Simple queries return just 1 sub-query (the original)
   - Output format is JSON array: [{"query": "...", "purpose": "..."}]
   - Queries are concise and search-optimized

3. **Added comprehensive tests for multi-step plan generation behavior:**
   - Prompt structure validation tests
   - Sub-query generation scenarios (simple, complex, multi-aspect queries)
   - advancedMaxSubqueries limiting tests
   - SubQuery structure validation tests
   - JSON parsing behavior tests
   - Error handling behavior documentation
   - Plan step in reasoning sequence tests
   - Integration with subsequent steps tests

### Test Results
- All 267 tests pass (251 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 30 new tests for multi-step plan generation behavior

### Files Changed
- `apps/api/src/services/advanced-rag.test.ts` (MODIFIED - added 30 tests for plan generation)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 2 - Implement sub-query retrieval and merging

### Completed Task
**Task:** Implement sub-query retrieval and merging
**Phase:** Phase 2 - Advanced RAG Service
**Status:** COMPLETED

### Implementation Summary
The sub-query retrieval and merging functionality was already implemented in the AdvancedRAGService as part of the initial file structure creation. This task verified the implementation and added comprehensive tests.

### Existing Implementation (verified):
1. **`executeSubQueries()` method:**
   - Executes all sub-queries in parallel using `Promise.all`
   - Calls `searchKnowledge()` for each sub-query
   - Collects and combines results from all sub-queries

2. **`searchKnowledge()` method:**
   - Generates embeddings for the query
   - Searches vector store with configured parameters (candidateK, similarityThreshold)
   - Limits results to topK per sub-query
   - Looks up chunk metadata from database
   - Returns RetrievedChunk objects with id, content, title, url, and score

3. **`mergeAndDeduplicateChunks()` method:**
   - Deduplicates chunks by ID using a Map
   - Keeps the chunk with the highest score when duplicates exist
   - Sorts results by score descending
   - Limits final results to topK

### Tests Added (23 new tests):
1. **Sub-Query Retrieval Behavior:**
   - Parallel execution using Promise.all
   - Result collection from multiple sub-queries
   - Single sub-query handling (simple query case)
   - Empty sub-query array handling
   - Empty KB list handling

2. **searchKnowledge Method:**
   - Embedding generation
   - Search parameter configuration
   - TopK limiting per sub-query
   - Vector store unavailable handling
   - Database chunk lookup
   - RetrievedChunk structure
   - Optional title/url fields
   - Heading fallback for title
   - normalizedUrl usage

3. **Search Step Reasoning Event:**
   - Event sequence (after plan step)
   - Sub-query count reporting
   - Singular/plural handling

4. **Chunk Merging and Deduplication:**
   - Deduplication by ID
   - Highest score preservation
   - Score-based sorting
   - TopK limiting
   - Empty array handling
   - Null config early return
   - Multi-sub-query overlap handling

5. **Merge Step Reasoning Event:**
   - Event sequence (after search step)
   - Deduplication summary reporting

6. **Status Event After Merging:**
   - Source count in status event
   - Zero sources handling
   - Event sequence verification

7. **RetrievedChunk Interface:**
   - Required fields (id, content, score)
   - Optional fields (title, url)
   - Score range validation

### Test Results
- All 290 tests pass (274 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 23 new tests for sub-query retrieval and merging

### Files Changed
- `apps/api/src/services/advanced-rag.test.ts` (MODIFIED - added 23 tests for sub-query retrieval and merging)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 2 - Implement reasoning event emission

### Completed Task
**Task:** Implement reasoning event emission
**Phase:** Phase 2 - Advanced RAG Service
**Status:** COMPLETED

### Implementation Summary
The reasoning event emission functionality was already implemented in the AdvancedRAGService as part of the initial file structure creation. This task verified the implementation and added comprehensive tests for reasoning event emission behavior.

### Existing Implementation (verified):
1. **ReasoningStep interface:**
   - Fields: id, type, title, summary, status, optional details
   - Types: "rewrite" | "plan" | "search" | "merge" | "generate"
   - Statuses: "pending" | "in_progress" | "completed" | "error"

2. **Reasoning event type:**
   - `{ type: "reasoning", step: ReasoningStep }`
   - Part of `AdvancedStreamEvent` union type

3. **Event emission flow:**
   - Each step emits twice: once with `in_progress` status, once with `completed` status
   - Total of 10 reasoning events per chat response (2 per step × 5 steps)
   - Steps emitted in order: rewrite → plan → search → merge → generate

4. **Step details:**
   - Rewrite step: Indicates if query was reformulated or used as-is
   - Plan step: Reports sub-query count and includes sub-query list in details
   - Search step: Reports query count and found chunk count
   - Merge step: Reports unique chunk count after deduplication
   - Generate step: Reports success on completion

### Tests Added (47 new tests):
1. **Reasoning event structure:**
   - Event type discriminator validation
   - Required fields in ReasoningStep
   - Optional details field handling

2. **Reasoning step emission order:**
   - Correct sequence (rewrite → plan → search → merge → generate)
   - Exactly 5 step types

3. **Reasoning step status transitions:**
   - Initial in_progress status
   - Completed status after processing
   - Two events per step (in_progress then completed)
   - Step ID preservation across transitions
   - Summary updates on completion

4. **Step-specific emission details:**
   - Rewrite step: Title, reformulation indication, truncation
   - Plan step: Title, sub-query count, singular/plural forms, details inclusion
   - Search step: Title, query count, chunk count
   - Merge step: Title, unique chunk count
   - Generate step: Title, success message

5. **Reasoning event counting:**
   - 10 total reasoning events
   - Reasoning steps count tracking for analytics

6. **Event type discrimination:**
   - Distinguishing from other event types
   - Type narrowing for step property access

7. **Error handling in reasoning steps:**
   - Error status support
   - Error event emission on failure

8. **Reasoning event integration:**
   - Status event after merge step
   - Text events after generate starts
   - Sources after generate completes
   - Done event last

9. **Step ID generation:**
   - Unique IDs for each step
   - UUID format

10. **SSE serialization compatibility:**
    - JSON serialization
    - SSE data event formatting

### Test Results
- All 337 tests pass (321 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 47 new tests for reasoning event emission

### Files Changed
- `apps/api/src/services/advanced-rag.test.ts` (MODIFIED - added 47 tests for reasoning event emission)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 2 - Implement final answer generation with citations

### Completed Task
**Task:** Implement final answer generation with citations
**Phase:** Phase 2 - Advanced RAG Service
**Status:** COMPLETED

### Implementation Summary
Enhanced the AdvancedRAGService's `buildSystemPrompt` method to include explicit citation instructions that guide the LLM to properly cite sources in its responses. Also added handling for when no context is retrieved.

### Changes Made:

1. **Enhanced `buildSystemPrompt()` method:**
   - Added `CITATION INSTRUCTIONS:` section with 5 rules for proper citation usage
   - Instructions include: use numbered sources, reference in brackets [1], [2], only cite supporting sources
   - Added emphasis on grounded responses based solely on provided context
   - Added special instruction when no chunks are retrieved: advises LLM to acknowledge lack of information

2. **Citation format in context:**
   - Chunks formatted with 1-indexed citation numbers: `[1]`, `[2]`, etc.
   - Title included when available: `[1] Title: Document Title\nContent...`
   - Context sections separated with double newlines for readability

3. **Added comprehensive tests (63 new tests) covering:**
   - System prompt construction with citation instructions
   - Citation format in context (numbered, 1-indexed)
   - Generate step behavior (title, summaries, event sequence)
   - Text streaming behavior (event sequence, accumulation)
   - Sources event behavior (building from chunks, maxCitations limiting)
   - Source interface validation
   - Conversation storage after generation
   - Token usage tracking
   - Usage logging (ok/error status, latency, rerankerUsed)
   - Done event behavior (final event, conversationId handling)
   - Error handling during generation
   - maxCitations configuration
   - LLM configuration
   - Message array construction
   - Citation-aware system prompt tests (empty context, context present, full structure)

### Test Results
- All 400 tests pass (384 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 63 new tests for final answer generation with citations

### Files Changed
- `apps/api/src/services/advanced-rag.ts` (MODIFIED - enhanced buildSystemPrompt with citation instructions)
- `apps/api/src/services/advanced-rag.test.ts` (MODIFIED - added 63 tests for final answer generation)
- `Tasks/tasks.yml` (MODIFIED - marked task complete, marked Phase 2 as completed)

## 2026-01-17: Phase 3 - Update admin chat route for RAG type routing

### Completed Task
**Task:** Update admin chat route for RAG type routing
**Phase:** Phase 3 - API Routing & Integration
**Status:** COMPLETED

### Changes Made

1. **Updated chat route to support RAG type routing:**
   - `apps/api/src/routes/chat.ts`
   - Added import for AdvancedRAGService
   - Added database imports (db, agents, eq, and, isNull from drizzle-orm)
   - Route now fetches agent's ragType before streaming
   - Routes to AdvancedRAGService when ragType is "advanced"
   - Routes to SimpleRAGService when ragType is "simple" (default)
   - Returns 404 error if agent not found

2. **Routing logic:**
   - Queries agent by agentId, tenantId, and deletedAt IS NULL
   - Only fetches ragType column for efficiency
   - AdvancedRAGService instantiated with "admin_ui" channel
   - SimpleRAGService used for simple mode (existing behavior)

3. **Added comprehensive tests:**
   - `apps/api/src/routes/chat.test.ts` (NEW - 58 tests)
   - chatSchema validation tests (message, conversationId)
   - RAG type routing logic tests
   - Agent lookup behavior tests
   - Stream event type tests (Simple and Advanced)
   - SSE headers tests
   - Rate limiting configuration tests

### Test Results
- All 458 tests pass (442 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 58 new tests for chat route RAG type routing

### Files Changed
- `apps/api/src/routes/chat.ts` (MODIFIED - added RAG type routing)
- `apps/api/src/routes/chat.test.ts` (NEW - 58 tests)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Phase 3 - Update widget chat helper for RAG type routing

### Completed Task
**Task:** Update widget chat helper for RAG type routing
**Phase:** Phase 3 - API Routing & Integration
**Status:** COMPLETED

### Changes Made

1. **Updated widget chat helper to support RAG type routing:**
   - `apps/api/src/services/widget-chat-helpers.ts`
   - Added import for AdvancedRAGService
   - Updated `handleWidgetChatStream()` to route based on agent's ragType
   - Routes to AdvancedRAGService when ragType is "advanced" (uses "widget" channel)
   - Routes to SimpleRAGService when ragType is "simple" (default)

2. **Routing logic:**
   - Agent is already fetched via `validateWidgetToken()` which returns full agent object
   - Checks `agent.ragType` to determine service
   - AdvancedRAGService instantiated with "widget" channel (distinct from "admin_ui" used in admin chat)
   - SimpleRAGService used for simple mode (existing behavior)

3. **Added comprehensive tests (31 new tests):**
   - RAG type routing logic tests (ragType handling, routing decision, service parameters)
   - WidgetTokenValidation type tests (widgetToken property, agent with ragType)
   - Stream event type tests (Simple and Advanced, including reasoning events)
   - Widget SSE headers tests
   - Widget rate limiting tests (key prefix, tenant-specific keys, default/custom limits)
   - Module exports tests

### Test Results
- All 489 tests pass (473 in api, 16 in web)
- All typecheck passes across 14 packages
- Added 31 new tests for widget chat RAG type routing

### Files Changed
- `apps/api/src/services/widget-chat-helpers.ts` (MODIFIED - added RAG type routing)
- `apps/api/src/services/widget-chat-helpers.test.ts` (MODIFIED - added 31 tests)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)
