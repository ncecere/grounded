## 2026-01-18: Define staged ingestion contract and per-stage status model

### Summary
Implemented the staged ingestion contract with per-stage status tracking for the ingestion pipeline.

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `IngestionStage` enum defining 6 pipeline stages: discover, fetch, extract, chunk, embed, index
   - Added `StageStatus` enum with 6 statuses: pending, in_progress, completed, failed_retryable, failed_permanent, skipped
   - Added `StageTimestamps` interface for per-stage timing
   - Added `SourceRunStatsV2` interface extending `SourceRunStats` with optional per-stage aggregate stats
   - Added `StageContracts` interface documenting inputs/outputs for each stage
   - Added `PageStageStatus` interface for tracking per-page stage status

2. **packages/shared/src/constants/index.ts**
   - Added `INGESTION_STAGES` array with ordered stages
   - Added `STAGE_MAX_RETRIES` with per-stage retry limits
   - Added `STAGE_RETRY_DELAY_MS` with per-stage retry delays

3. **packages/db/src/schema/knowledge.ts**
   - Added `currentStage` field to `sourceRunPages` table for tracking current pipeline stage
   - Added `sourceRunPageStages` table for detailed per-page stage tracking with status, timestamps, error, retryCount, and metadata

4. **packages/shared/src/types/ingestion-stages.test.ts** (new file)
   - Added 60 tests covering all new types, enums, and constants
   - Tests validate type correctness, backwards compatibility, and pipeline documentation

### Acceptance Criteria Met
- ✅ Document inputs/outputs for discover, fetch, extract, chunk, embed, index (via StageContracts interface)
- ✅ Define per-stage status fields and timestamps (via IngestionStage, StageStatus, PageStageStatus, sourceRunPageStages table)
- ✅ Preserve compatibility with existing runs (SourceRunStatsV2 extends SourceRunStats, new fields are optional)

### Tests
- All 60 new tests pass
- All existing tests pass (1306 tests across all packages)
- TypeScript typechecking passes

## 2026-01-18: Standardize job payload schemas for web and upload sources

### Summary
Implemented standardized Zod schemas for all job payloads with clear distinction between web and upload sources, validation helpers, and type guards.

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `baseJobSchema` - Zod schema for common job fields (requestId, traceId)
   - Added `webSourceJobConfigSchema` - Web source configuration (mode, fetchMode, depth, patterns, etc.)
   - Added `uploadSourceJobConfigSchema` - Upload source configuration (uploadId, filename, mimeType, sizeBytes)
   - Added `sourceJobConfigSchema` - Discriminated union of web/upload configs
   - Added `webSourceRunStartJobSchema` - Schema for starting web source runs
   - Added `webSourceDiscoverJobSchema` - Schema for URL discovery jobs
   - Added `pageFetchJobSchema` - Schema for page fetch jobs with optional parentUrl
   - Added `uploadSourceRunStartJobSchema` - Schema for starting upload source runs
   - Added `pageProcessJobSchema` - Unified schema for both web/upload with sourceType and uploadMetadata fields
   - Added `embedChunksBatchJobSchema` - Schema with optional embeddingConfig
   - Added `enrichPageJobSchema` - Schema with optional sourceType hint
   - Added `sourceRunFinalizeJobSchema` - Schema with optional sourceType
   - Added `hardDeleteObjectJobSchema` - Schema with cascade option
   - Added `kbReindexJobSchema` - Schema with deleteOldEmbeddings option
   - Added union types: `SourceRunJobPayload`, `IngestionJobPayload`, `AnyJobPayload`
   - Added `validateJobPayload()` - Throws on validation failure
   - Added `safeValidateJobPayload()` - Returns success/error result
   - Added `isWebSourcePayload()` and `isUploadSourcePayload()` type guards

2. **packages/shared/src/types/job-payloads.test.ts** (new file)
   - Added 59 tests covering all new schemas
   - Tests validate schema parsing, default values, constraints, and type compatibility
   - Tests backwards compatibility with existing payload patterns

### Key Design Decisions
- **Discriminated Union**: Used `sourceType` as discriminator to distinguish web vs upload payloads
- **Optional Extensions**: New fields (sourceConfig, uploadMetadata, embeddingConfig) are optional to maintain backwards compatibility
- **Zod Validation**: All schemas use Zod for runtime validation with TypeScript type inference
- **URL Flexibility**: `pageProcessJobSchema` accepts both HTTP URLs and `upload://` URIs

### Acceptance Criteria
- ✅ Standardized schemas for web and upload sources with clear type distinctions
- ✅ Validation schemas (Zod) for all job payloads
- ✅ Backwards compatible with existing job structures

### Tests
- All 59 new tests pass
- All existing tests pass (1306 tests across all packages)
- TypeScript typechecking passes

## 2026-01-18: Define error taxonomy with retryable vs permanent categories

### Summary
Implemented a comprehensive error classification system with retryable vs permanent error categories for the ingestion pipeline. The taxonomy enables intelligent retry decisions, proper stage status tracking, and structured error logging.

### Changes Made
1. **packages/shared/src/errors/index.ts** (new file)
   - Added `ErrorCategory` enum with 9 categories: network, service, content, configuration, not_found, validation, auth, system, unknown
   - Added `ErrorCode` enum with 35 specific error codes across all categories
   - Added `ERROR_RETRYABILITY` map classifying each error code as retryable or permanent
   - Added `ERROR_CATEGORIES` map linking error codes to their categories
   - Added `IngestionError` base class extending Error with code, category, retryable, cause, metadata, and httpStatus properties
   - Added specialized error classes: `NetworkError`, `ServiceError`, `ContentError`, `ConfigurationError`, `NotFoundError`, `ValidationError`, `AuthError`, `SystemError`
   - Added type aliases for error codes: `ServiceErrorCode`, `ContentErrorCode`, `ConfigurationErrorCode`, `NotFoundErrorCode`, `ValidationErrorCode`, `AuthErrorCode`
   - Added utility functions:
     - `isRetryableError()` - Determines if an error is retryable
     - `classifyHttpStatus()` - Maps HTTP status codes to error codes
     - `classifyError()` - Classifies generic errors into structured IngestionErrors
     - `getErrorInfo()` - Extracts error information for logging
     - `createHttpError()` - Creates appropriate error type from HTTP status

2. **packages/shared/src/index.ts**
   - Added export for the new errors module

3. **packages/shared/src/errors/errors.test.ts** (new file)
   - Added 89 tests covering all error categories, codes, and utilities
   - Tests validate retryability classification, error creation, and utility functions
   - Tests cover edge cases and error classification patterns

### Key Design Decisions
- **Retryable by default**: Network timeouts, connection errors, 5xx HTTP errors, and database errors are retryable
- **Permanent errors**: Content errors (too large, invalid format), configuration errors, validation errors, and auth errors are permanent
- **Conservative approach**: Unknown errors default to retryable to avoid dropping recoverable failures
- **Structured logging**: All errors serialize to JSON with code, category, message, retryable status, and cause

### Error Categories
| Category | Retryable | Examples |
|----------|-----------|----------|
| network | mostly yes | timeout, connection refused, DNS failure |
| service | mostly yes | rate limited, 503, 502, gateway timeout |
| content | no | too large, invalid format, empty content |
| configuration | no | missing API key, dimension mismatch |
| not_found | no | resource not found, KB not found |
| validation | no | invalid URL, schema violation |
| auth | no | unauthorized, forbidden |
| system | varies | database error (yes), disk full (no) |
| unknown | yes | unclassified errors |

### Acceptance Criteria Met
- ✅ Define error taxonomy with retryable vs permanent categories
- ✅ Comprehensive error codes for all ingestion scenarios
- ✅ Utility functions for error classification and logging

### Tests
- All 89 new tests pass
- All existing tests pass (208 tests in shared package)
- TypeScript typechecking passes

## 2026-01-18: Split queues by stage and define concurrency defaults

### Summary
Implemented a mapping between ingestion stages and queues with configurable concurrency defaults. This enables fine-grained control over parallelism at both the stage and queue level, with environment variable overrides for deployment flexibility.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `STAGE_QUEUE_MAPPING` - Maps each of the 6 ingestion stages to their primary queue
   - Added `STAGE_DEFAULT_CONCURRENCY` - Default concurrency limits per stage with documented rationale
   - Added `STAGE_CONCURRENCY_ENV_VARS` - Environment variable names for per-stage concurrency overrides
   - Added `QUEUE_DEFAULT_CONCURRENCY` - Default concurrency for all 7 queues
   - Added `QUEUE_CONCURRENCY_ENV_VARS` - Environment variable names for per-queue concurrency overrides

2. **packages/shared/src/types/index.ts**
   - Added `QueueName` type for queue name type safety
   - Added `QueueConfig` interface with name, defaultConcurrency, concurrencyEnvVar, and stages fields
   - Added helper functions:
     - `getQueueForStage()` - Get queue name for a given stage
     - `getStageConcurrency()` - Get default concurrency for a stage
     - `getStageConcurrencyEnvVar()` - Get env var name for stage concurrency override
     - `getQueueConcurrency()` - Get default concurrency for a queue
     - `getQueueConcurrencyEnvVar()` - Get env var name for queue concurrency override
     - `getStagesForQueue()` - Get all stages that use a given queue
     - `buildQueueConfigMap()` - Build complete queue configuration map
     - `resolveQueueConcurrency()` - Resolve effective queue concurrency with env var support
     - `resolveStageConcurrency()` - Resolve effective stage concurrency with env var support

3. **packages/queue/src/index.ts**
   - Re-exported all new constants and helper functions for consumer convenience

4. **packages/shared/src/types/queue-config.test.ts** (new file)
   - Added 63 tests covering:
     - Stage-to-queue mapping validation
     - Concurrency defaults for all stages and queues
     - Environment variable naming conventions
     - Helper function behavior
     - Concurrency resolution with env var overrides
     - Cross-validation ensuring all stages and queues are covered

### Stage-to-Queue Mapping
| Stage | Queue | Rationale |
|-------|-------|-----------|
| discover | source-run | Orchestration stage |
| fetch | page-fetch | Network-bound, separate worker |
| extract | page-process | CPU-bound extraction |
| chunk | page-process | CPU-bound, shares with extract |
| embed | embed-chunks | API-bound embeddings |
| index | embed-chunks | Follows embedding, shares queue |

### Default Concurrency Settings
| Stage | Default | Rationale |
|-------|---------|-----------|
| discover | 2 | Low to avoid overwhelming source servers |
| fetch | 5 | Moderate for network-bound, polite to targets |
| extract | 10 | CPU-bound, parallelizable |
| chunk | 10 | Lightweight CPU-bound |
| embed | 4 | API rate limited by external providers |
| index | 8 | Database-bound, limited for connection pool |

### Environment Variables
Per-stage: `DISCOVER_CONCURRENCY`, `FETCH_CONCURRENCY`, `EXTRACT_CONCURRENCY`, `CHUNK_CONCURRENCY`, `EMBED_CONCURRENCY`, `INDEX_CONCURRENCY`

Per-queue: `SOURCE_RUN_CONCURRENCY`, `PAGE_FETCH_CONCURRENCY`, `PAGE_PROCESS_CONCURRENCY`, `EMBED_CHUNKS_CONCURRENCY`, `ENRICH_PAGE_CONCURRENCY`, `DELETION_CONCURRENCY`, `KB_REINDEX_CONCURRENCY`

### Acceptance Criteria Met
- ✅ Split queues by stage with clear mapping between stages and queues
- ✅ Define concurrency defaults with documented rationale for each stage
- ✅ Environment variable support for deployment-time overrides

### Tests
- All 63 new tests pass
- All existing tests pass (271 tests in shared package, 1306 total)
- TypeScript typechecking passes

## 2026-01-18: Add per-tenant and per-domain concurrency limits

### Summary
Implemented per-tenant and per-domain concurrency limits for the fetch/crawl pipeline. This prevents any single tenant from consuming all worker capacity and protects target servers from being overwhelmed by concurrent connections.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `DEFAULT_TENANT_CONCURRENCY` (5) - Default concurrent fetch jobs per tenant
   - Added `DEFAULT_DOMAIN_CONCURRENCY` (3) - Default concurrent fetch jobs per domain
   - Added `DOMAIN_CONCURRENCY_ENV_VAR` - Environment variable for domain concurrency override
   - Added `CONCURRENCY_KEY_PREFIXES` - Redis key prefixes for tenant, domain, and tenant+domain tracking
   - Added `CONCURRENCY_KEY_TTL_SECONDS` (300) - TTL for tracking keys
   - Added `CONCURRENCY_RETRY_DELAY_MS` (5000) - Retry delay for rate-limited jobs

2. **packages/shared/src/types/index.ts**
   - Added `ConcurrencyCheckResult` interface - Result of single limit check
   - Added `CombinedConcurrencyCheckResult` interface - Combined result of all limit checks
   - Added `ActiveJobTracker` interface - Tracks active jobs for cleanup
   - Added `ConcurrencyLimitOptions` interface - Options for limit configuration
   - Added `ConcurrencyMetrics` interface - Metrics snapshot for monitoring
   - Added `extractDomainFromUrl()` - Extracts and normalizes domain from URL
   - Added `buildTenantConcurrencyKey()` - Builds Redis key for tenant tracking
   - Added `buildDomainConcurrencyKey()` - Builds Redis key for domain tracking
   - Added `buildTenantDomainConcurrencyKey()` - Builds Redis key for combined tracking
   - Added `resolveDomainConcurrency()` - Resolves domain limit with env var support
   - Added `getTenantConcurrencyLimit()` - Gets tenant limit from quotas
   - Added `createConcurrencyLimitOptions()` - Creates options from quotas and env
   - Added `getConcurrencyKeyTtl()` / `getConcurrencyRetryDelay()` - Getter helpers

3. **packages/queue/src/index.ts**
   - Added `checkTenantConcurrency()` - Checks if tenant has capacity
   - Added `checkDomainConcurrency()` - Checks if domain has capacity
   - Added `checkTenantDomainConcurrency()` - Checks combined tenant+domain limit
   - Added `checkFetchConcurrencyLimits()` - Checks all applicable limits
   - Added `acquireFetchConcurrencySlots()` - Atomically increments counters
   - Added `releaseFetchConcurrencySlots()` - Decrements counters on job completion
   - Added `getTenantActiveFetchCount()` / `getDomainActiveFetchCount()` - Monitoring helpers
   - Added `resetTenantConcurrency()` / `resetDomainConcurrency()` - Emergency cleanup
   - Added `createConcurrencyOptionsFromQuotas()` - Creates options from quotas
   - Re-exported all new constants and types

4. **packages/shared/src/types/concurrency-limits.test.ts** (new file)
   - Added 70 tests covering:
     - All concurrency constants and their values
     - Domain extraction from URLs (normalization, www removal, case handling)
     - Redis key building functions
     - Limit resolution functions with env var overrides
     - Type interface validation
     - Integration scenarios for multi-tenant domain sharing

### Key Design Decisions
- **Per-domain limits**: Applied globally across all tenants to prevent overwhelming target servers (default: 3)
- **Per-tenant limits**: Uses existing `TenantQuotas.maxCrawlConcurrency` field (default: 5)
- **Domain normalization**: Removes www prefix and lowercases for consistent tracking
- **Redis-based tracking**: Uses INCR/DECR with TTL for atomic, self-healing counters
- **Optional tenant+domain**: Allows stricter per-tenant-per-domain limits when needed

### Concurrency Limits
| Type | Default | Rationale |
|------|---------|-----------|
| Per-tenant | 5 | Prevents single tenant from consuming all capacity |
| Per-domain | 3 | Protects target servers from being overwhelmed |

### Redis Key Patterns
- Tenant: `concurrency:tenant:{tenantId}`
- Domain: `concurrency:domain:{domain}`
- Combined: `concurrency:tenant_domain:{tenantId}:{domain}`

### Environment Variables
- `DOMAIN_CONCURRENCY` - Override default per-domain limit

### Acceptance Criteria Met
- ✅ Per-tenant concurrency limits with TenantQuotas integration
- ✅ Per-domain concurrency limits to protect target servers
- ✅ Redis-based atomic tracking with TTL for auto-cleanup
- ✅ Helper functions for checking and managing limits
- ✅ Integration with existing quota system

### Tests
- All 70 new tests pass
- All existing tests pass (341 tests in shared package)
- TypeScript typechecking passes

## 2026-01-18: Implement embed lag backpressure for process queue

### Summary
Implemented embed lag backpressure for the page-process queue to prevent unbounded embed queue growth. When the embed queue depth or embed lag exceeds configurable thresholds, page-process jobs will pause before queuing more embed jobs, allowing the embed workers to catch up.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `DEFAULT_EMBED_QUEUE_THRESHOLD` (100) - Queue depth threshold before backpressure
   - Added `DEFAULT_EMBED_LAG_THRESHOLD` (500) - Chunks awaiting embedding threshold
   - Added `EMBED_BACKPRESSURE_DELAY_MS` (2000) - Delay between backpressure checks
   - Added `EMBED_BACKPRESSURE_MAX_WAIT_CYCLES` (10) - Maximum wait iterations
   - Added `EMBED_BACKPRESSURE_ENV_VARS` - Environment variable names for all settings
   - Added `EMBED_BACKPRESSURE_KEY` - Redis key for tracking
   - Added `EMBED_BACKPRESSURE_KEY_TTL_SECONDS` (600) - TTL for tracking key

2. **packages/shared/src/types/index.ts**
   - Added `EmbedBackpressureCheckResult` interface - Result of backpressure check
   - Added `EmbedBackpressureConfig` interface - Configuration options
   - Added `EmbedBackpressureWaitResult` interface - Status of wait operation
   - Added `EmbedBackpressureMetrics` interface - Metrics for monitoring
   - Added `resolveEmbedBackpressureConfig()` - Resolve config from env vars
   - Added `getDefaultEmbedBackpressureConfig()` - Get default config
   - Added `checkEmbedBackpressure()` - Check if backpressure should apply
   - Added `calculateEmbedBackpressureMetrics()` - Calculate metrics for monitoring
   - Added `getEmbedBackpressureKey()` / `getEmbedBackpressureKeyTtl()` - Helper getters

3. **packages/queue/src/index.ts**
   - Added `getEmbedBackpressureConfig()` - Get cached config
   - Added `resetEmbedBackpressureConfigCache()` - Reset config cache for testing
   - Added `getEmbedQueueDepth()` - Get current embed queue depth from BullMQ
   - Added `getEmbedQueueDepthFromRedis()` - Fallback Redis-based counter
   - Added `incrementEmbedQueueDepth()` / `decrementEmbedQueueDepth()` - Counter operations
   - Added `resetEmbedQueueDepth()` - Reset counter (for testing/emergency)
   - Added `checkCurrentEmbedBackpressure()` - Check backpressure with live metrics
   - Added `waitForEmbedBackpressure()` - Wait loop for backpressure to clear
   - Added `getEmbedBackpressureMetrics()` - Get metrics for monitoring
   - Re-exported all new types and constants from @grounded/shared

4. **apps/ingestion-worker/src/processors/page-process.ts**
   - Added import for backpressure functions
   - Added backpressure check before queuing embed jobs
   - Logs backpressure wait events with timing details

5. **packages/shared/src/types/embed-backpressure.test.ts** (new file)
   - Added 54 tests covering all new types, constants, and functions
   - Tests validate configuration resolution, backpressure checks, metrics calculation
   - Tests cover edge cases and integration scenarios

### Key Design Decisions
- **Dual threshold system**: Both queue depth (pending jobs) and embed lag (chunks awaiting embedding) are checked
- **Queue depth takes priority**: If queue is full, don't add more regardless of lag
- **Configurable via env vars**: All thresholds and delays can be tuned without code changes
- **Disable option**: Can be fully disabled via `EMBED_BACKPRESSURE_DISABLED=true`
- **Max wait to avoid stalls**: Jobs won't wait forever (default 20s max)
- **Non-blocking for normal ops**: Only activates when thresholds are exceeded

### Backpressure Thresholds
| Metric | Default | Env Var | Rationale |
|--------|---------|---------|-----------|
| Queue Depth | 100 | EMBED_QUEUE_THRESHOLD | Prevents unbounded queue growth |
| Embed Lag | 500 | EMBED_LAG_THRESHOLD | Tracks chunks awaiting embedding |
| Wait Delay | 2000ms | EMBED_BACKPRESSURE_DELAY_MS | Time between recheck attempts |
| Max Cycles | 10 | EMBED_BACKPRESSURE_MAX_WAIT_CYCLES | Max wait = 20 seconds |

### Environment Variables
- `EMBED_QUEUE_THRESHOLD` - Override queue depth threshold
- `EMBED_LAG_THRESHOLD` - Override lag threshold
- `EMBED_BACKPRESSURE_DELAY_MS` - Override delay between checks
- `EMBED_BACKPRESSURE_MAX_WAIT_CYCLES` - Override max wait iterations
- `EMBED_BACKPRESSURE_DISABLED` - Set to "true" or "1" to disable

### Acceptance Criteria Met
- ✅ Implement embed lag backpressure for process queue
- ✅ Configurable thresholds via environment variables
- ✅ Logging of backpressure events for observability
- ✅ Non-blocking timeout to prevent job stalls

### Tests
- All 54 new tests pass
- All existing tests pass (395 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Enforce HTML content-type allowlist in fetch

### Summary
Implemented HTML content-type validation in the fetch stage of the ingestion pipeline. Non-HTML content (PDFs, images, binaries, JSON, etc.) is now rejected during HTTP fetch, preventing unnecessary processing of non-HTML resources.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `HTML_CONTENT_TYPES` array with allowed MIME types: text/html, application/xhtml+xml, application/xml, text/xml
   - Added `NON_HTML_CONTENT_TYPES` array with 35+ blocked MIME types including documents, images, audio/video, archives, binaries, and data formats
   - Added `HTML_CONTENT_TYPE_ENFORCEMENT_DISABLED_ENV_VAR` for optional enforcement bypass

2. **packages/shared/src/types/index.ts**
   - Added `ContentTypeValidationResult` interface for validation results with isValid, mimeType, charset, category, and rejectionReason
   - Added `ContentTypeValidationConfig` interface for configuration
   - Added `parseContentType()` - Parses content-type header into mimeType and charset components
   - Added `isHtmlMimeType()` - Checks if a MIME type is in the HTML allowlist
   - Added `isBlockedMimeType()` - Checks if a MIME type is explicitly blocked
   - Added `validateHtmlContentType()` - Full validation returning detailed result
   - Added `getContentTypeValidationConfig()` - Get config from environment
   - Added `isContentTypeEnforcementEnabled()` - Check if enforcement is enabled

3. **apps/scraper-worker/src/processors/page-fetch.ts**
   - Added content-type validation in `fetchWithHttp()` function
   - Validates content-type header immediately after HTTP status check
   - Throws `ContentError` with `CONTENT_UNSUPPORTED_TYPE` code for non-HTML content
   - Logs skipped pages with content type details for debugging
   - Logs warning for pages with unknown/empty content types (allowed through)

4. **packages/shared/src/types/content-type-allowlist.test.ts** (new file)
   - Added 78 tests covering all constants, parsing, validation, and configuration functions
   - Tests cover HTML types, blocked types, unknown types, edge cases, and integration scenarios

### Key Design Decisions
- **Allowlist approach**: Only explicitly listed HTML types are allowed (text/html, xhtml, xml)
- **Empty content-type**: Allowed through with warning (some servers don't send it)
- **Unknown types**: Rejected to be safe (not in allowlist = not allowed)
- **XML types included**: Allowed because some servers serve HTML as XML
- **Environment override**: Can be disabled via `HTML_CONTENT_TYPE_ENFORCEMENT_DISABLED=true` if needed
- **Uses existing error taxonomy**: Throws `ContentError` with `CONTENT_UNSUPPORTED_TYPE` (permanent, non-retryable)

### Content-Type Categories
| Category | Behavior | Examples |
|----------|----------|----------|
| html | Allowed | text/html, application/xhtml+xml |
| non_html | Blocked | application/pdf, image/*, application/json |
| unknown | Blocked | Custom/unrecognized types |
| empty | Allowed (with warning) | Missing Content-Type header |

### Environment Variables
- `HTML_CONTENT_TYPE_ENFORCEMENT_DISABLED` - Set to "true" or "1" to bypass validation

### Acceptance Criteria Met
- ✅ Enforce HTML content-type allowlist in fetch stage
- ✅ Block common non-HTML types (PDFs, images, binaries, JSON, etc.)
- ✅ Integration with error taxonomy (ContentError, non-retryable)
- ✅ Logging of skipped pages for debugging and reporting

### Tests
- All 78 new tests pass
- All existing tests pass (473 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Add skipped_non_html status with reason tracking

### Summary
Implemented a comprehensive skip reason tracking system for the ingestion pipeline. Added `SKIPPED_NON_HTML` status to `PageStatus` enum and introduced a `SkipReason` enum with helper functions for creating, converting, and managing skip details. This enables proper categorization and tracking of pages skipped due to non-HTML content types.

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `SKIPPED_NON_HTML: "skipped_non_html"` to `PageStatus` enum
   - Added `SkipReason` enum with 6 categorized reasons:
     - `NON_HTML_CONTENT_TYPE` - Content type is not HTML
     - `CONTENT_UNCHANGED` - Content unchanged since last crawl
     - `ROBOTS_BLOCKED` - URL blocked by robots.txt
     - `DEPTH_EXCEEDED` - URL exceeds depth limit
     - `PATTERN_EXCLUDED` - URL excluded by pattern filter
     - `ALREADY_CRAWLED` - URL already crawled in this run
   - Added `PageSkipDetails` interface for structured skip metadata storage
   - Added helper functions:
     - `createNonHtmlSkipDetails()` - Creates skip details for non-HTML content
     - `createContentUnchangedSkipDetails()` - Creates skip details for unchanged content
     - `createRobotsBlockedSkipDetails()` - Creates skip details for robots.txt blocks
     - `createDepthExceededSkipDetails()` - Creates skip details for depth limit
     - `createPatternExcludedSkipDetails()` - Creates skip details for pattern exclusions
     - `createAlreadyCrawledSkipDetails()` - Creates skip details for duplicate URLs
     - `skipReasonToPageStatus()` - Maps SkipReason to PageStatus
     - `isSkippedStatus()` - Checks if a status indicates a skip
     - `pageStatusToSkipReason()` - Reverse mapping from PageStatus to SkipReason

2. **packages/db/src/schema/knowledge.ts**
   - Updated `sourceRunPages.status` type to include `"skipped_non_html"` in the union type

3. **packages/shared/src/types/skip-reason-tracking.test.ts** (new file)
   - Added 55 tests covering:
     - PageStatus enum validation
     - SkipReason enum validation
     - All skip detail creation functions
     - Skip reason to page status mapping
     - isSkippedStatus helper
     - Page status to skip reason mapping
     - PageSkipDetails interface validation
     - Integration tests for round-trip conversions
     - Type safety tests

### Key Design Decisions
- **Extensible enum approach**: `SkipReason` is designed to support future skip reasons with minimal changes
- **Detailed metadata**: `PageSkipDetails` interface captures stage, timestamp, and reason-specific details
- **Bidirectional mapping**: Functions support converting between SkipReason and PageStatus for flexibility
- **Stage awareness**: Each skip reason tracks which ingestion stage triggered it
- **Structured storage**: Details are designed to be stored in `sourceRunPageStages.metadata` field

### Skip Reason Categories
| Reason | Stage | Description |
|--------|-------|-------------|
| non_html_content_type | fetch | Content-Type header is not HTML |
| content_unchanged | fetch | Content hash matches previous crawl |
| robots_blocked | discover | URL blocked by robots.txt |
| depth_exceeded | discover | URL depth exceeds max depth setting |
| pattern_excluded | discover | URL matches exclusion pattern |
| already_crawled | discover | URL already processed in this run |

### PageSkipDetails Structure
```typescript
{
  reason: SkipReason;
  description: string;
  stage: IngestionStage;
  skippedAt: string; // ISO timestamp
  details?: {
    contentType?: string;
    mimeType?: string;
    contentCategory?: "non_html" | "unknown";
    contentHash?: string;
    depth?: number;
    maxDepth?: number;
    pattern?: string;
    httpStatus?: number;
  };
}
```

### Acceptance Criteria Met
- ✅ Add skipped_non_html status with reason tracking
- ✅ SkipReason enum with categorized reasons for future extensibility
- ✅ Helper functions for creating skip details with appropriate metadata
- ✅ Database schema updated to support new status
- ✅ Bidirectional mapping between skip reasons and page statuses

### Tests
- All 55 new tests pass
- All existing tests pass (528 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-20: Add TanStack Query hooks for test suites

### Summary
Added dedicated React Query hooks and query keys for the test suites API, including polling for active runs and cache invalidation for mutations.

### Changes Made
1. **apps/web/src/lib/api/test-suites.hooks.ts**
   - Added query key helpers for suites, cases, runs, and analytics
   - Added query hooks for suites, cases, runs, and analytics with polling for in-progress runs
   - Added mutation hooks for suite/case/run workflows with cache invalidation

2. **apps/web/src/lib/api/index.ts**
   - Exported the new test suite hooks

3. **apps/web/src/lib/api/test-suites.hooks.test.ts** (new file)
   - Added export and signature coverage for the new hooks

### Tests
- `bun test apps/web/src/lib/api/test-suites.hooks.test.ts`

## 2026-01-19: Add test suite API routes

### Summary
Implemented test suite CRUD routes and agent-scoped listing/creation with Zod validation.

### Changes Made
1. **apps/api/src/routes/test-suites.ts**
   - Added agent-scoped list/create routes for test suites
   - Added suite-level get/update/delete routes with tenant validation
   - Implemented scheduling and alert setting validation via Zod

2. **apps/api/src/index.ts**
   - Mounted new agent and test suite routes under `/api/v1`

3. **apps/api/src/routes/test-suites.test.ts** (new file)
   - Added schema validation tests for schedule settings and alert thresholds

### Tests
- `bun test apps/api/src/routes/test-suites.test.ts`

## 2026-01-18: Disable Playwright downloads during crawl

### Summary
Implemented Playwright download prevention during web crawling to protect against disk space consumption, slow page loading, and security risks from downloading untrusted files. Downloads are disabled by default using Playwright's `acceptDownloads: false` context option, with optional logging of blocked download events.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `PLAYWRIGHT_DOWNLOADS_DISABLED_ENV_VAR` - Environment variable to override download prevention
   - Added `PLAYWRIGHT_LOG_BLOCKED_DOWNLOADS_ENV_VAR` - Environment variable to control download event logging
   - Added `PLAYWRIGHT_DOWNLOADS_DISABLED_DEFAULT` (true) - Downloads disabled by default
   - Added `PLAYWRIGHT_LOG_BLOCKED_DOWNLOADS_DEFAULT` (true) - Logging enabled by default

2. **packages/shared/src/types/index.ts**
   - Added `PlaywrightDownloadConfig` interface with `downloadsDisabled` and `logBlockedDownloads` fields
   - Added `BlockedDownloadInfo` interface for structured logging of blocked downloads (pageUrl, downloadUrl, suggestedFilename, blockedAt)
   - Added `isPlaywrightDownloadsDisabled()` - Checks if downloads should be disabled (defaults to true)
   - Added `shouldLogBlockedDownloads()` - Checks if blocked downloads should be logged
   - Added `getPlaywrightDownloadConfig()` - Gets full download configuration from environment
   - Added `createBlockedDownloadInfo()` - Creates structured info for logging blocked downloads
   - Re-exported all new constants for convenience

3. **apps/scraper-worker/src/processors/page-fetch.ts**
   - Updated `fetchWithPlaywright()` to use `acceptDownloads: false` in browser context when downloads disabled
   - Added download event handler to log blocked downloads with structured info
   - Downloads are canceled immediately when intercepted

4. **packages/shared/src/types/playwright-downloads.test.ts** (new file)
   - Added 40 tests covering all new types, constants, and functions
   - Tests validate configuration resolution, download info creation, interface compliance
   - Tests cover edge cases (empty URLs, long URLs, unicode filenames, special characters)
   - Tests cover integration scenarios for different crawl configurations

### Key Design Decisions
- **Disabled by default**: Downloads are disabled by default for safety during crawling
- **Environment variable override**: Can be enabled via `PLAYWRIGHT_DOWNLOADS_DISABLED=false` if needed (not recommended)
- **Structured logging**: Blocked downloads are logged with pageUrl, downloadUrl, suggestedFilename, and timestamp
- **Opt-out logging**: Download event logging can be disabled via `PLAYWRIGHT_LOG_BLOCKED_DOWNLOADS=false`
- **Context-level blocking**: Uses Playwright's `acceptDownloads: false` for reliable blocking at context level

### Configuration Options
| Setting | Default | Env Var | Description |
|---------|---------|---------|-------------|
| Downloads disabled | true | PLAYWRIGHT_DOWNLOADS_DISABLED | Set to "false" or "0" to allow downloads |
| Log blocked downloads | true | PLAYWRIGHT_LOG_BLOCKED_DOWNLOADS | Set to "false" or "0" to disable logging |

### Acceptance Criteria Met
- ✅ Disable Playwright downloads during crawl (via acceptDownloads: false)
- ✅ Configurable via environment variable for edge cases
- ✅ Logging of blocked download events for debugging and monitoring
- ✅ Safe defaults (downloads disabled, logging enabled)

### Tests
- All 40 new tests pass
- All existing tests pass (568 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Implement exponential backoff with jitter for retryable errors

### Summary
Implemented exponential backoff with jitter for retry operations in the ingestion pipeline. The implementation provides configurable backoff delays with randomized jitter to prevent thundering herd problems, stage-specific retry configurations, and integration with the existing error taxonomy.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `DEFAULT_BACKOFF_BASE_DELAY_MS` (1000ms) - Base delay for first retry
   - Added `DEFAULT_BACKOFF_MAX_DELAY_MS` (60000ms) - Maximum delay cap
   - Added `DEFAULT_BACKOFF_MULTIPLIER` (2) - Exponential growth factor
   - Added `DEFAULT_BACKOFF_JITTER_RATIO` (0.3) - 30% max random jitter
   - Added `DEFAULT_MAX_RETRY_ATTEMPTS` (3) - Default retry limit
   - Added `BACKOFF_ENV_VARS` - Environment variable names for overrides
   - Added `STAGE_BACKOFF_CONFIG` - Per-stage backoff configurations with tuned values for each stage's characteristics

2. **packages/shared/src/types/index.ts**
   - Added `BackoffConfig` interface - Configuration for exponential backoff (baseDelayMs, maxDelayMs, multiplier, jitterRatio)
   - Added `RetryOptions` interface - Complete retry options including maxAttempts, backoff config, isRetryable function, onRetry callback, and retryAfterSeconds
   - Added `RetryResult<T>` interface - Detailed result with success status, value, error, attempts, totalWaitTimeMs, and attemptDetails
   - Added `RetryAttemptDetail` interface - Per-attempt tracking (attempt number, succeeded, error, delay, startedAt, durationMs)
   - Added `BackoffDelayInfo` interface - Calculated delay details (baseDelayMs, jitterMs, totalDelayMs, attempt, wasCapped, usedRetryAfter)
   - Added helper functions:
     - `getDefaultBackoffConfig()` - Returns default backoff configuration
     - `getDefaultRetryOptions()` - Returns default retry options
     - `resolveBackoffConfig()` - Resolves config from environment variables
     - `getBackoffConfigForStage()` - Gets stage-specific backoff config
     - `getMaxRetriesForStage()` - Gets max retries for a stage
     - `getRetryOptionsForStage()` - Gets complete retry options for a stage
     - `calculateJitter()` - Generates random jitter value
     - `calculateBackoffDelay()` - Calculates delay for a specific attempt
     - `generateBackoffSchedule()` - Generates preview of all retry delays
     - `calculateMaxTotalWaitTime()` - Calculates worst-case total wait time
     - `sleepMs()` - Promise-based sleep utility
     - `executeWithBackoff()` - Main retry executor with full backoff logic
     - `createRetryFunction()` - Creates bound retry function with preset options
     - `createStageRetryFunction()` - Creates stage-specific retry function

3. **packages/shared/src/types/exponential-backoff.test.ts** (new file)
   - Added 64 tests covering all new types, constants, and functions
   - Tests validate exponential growth, jitter bounds, max delay capping
   - Tests cover Retry-After header support, non-retryable error handling
   - Tests validate onRetry callbacks and attempt detail tracking
   - Tests cover integration with existing error taxonomy (isRetryableError)

### Key Design Decisions
- **Full jitter strategy**: Jitter is added as `random(0, baseDelay * jitterRatio)` to prevent thundering herd
- **Exponential formula**: `min(maxDelay, baseDelay * multiplier^(attempt-1)) + jitter`
- **Retry-After support**: HTTP Retry-After headers override calculated backoff (still adds small jitter)
- **Stage-specific tuning**: Each ingestion stage has optimized backoff settings:
  - discover: 2s base, 30s max, 0.25 jitter (network errors)
  - fetch: 5s base, 60s max, 0.3 jitter (rate limiting, polite crawling)
  - extract: 1s base, 15s max, 0.2 jitter (CPU-bound)
  - chunk: 0.5s base, 5s max, 0.1 jitter (lightweight)
  - embed: 3s base, 60s max, 0.35 jitter (API rate limits)
  - index: 2s base, 30s max, 0.25 jitter (database contention)
- **Detailed tracking**: Each attempt records timing, errors, and delays for observability

### Backoff Schedule Example (default config)
| Attempt | Base Delay | Max Jitter | Total Range |
|---------|------------|------------|-------------|
| 1 | 1000ms | 300ms | 1000-1300ms |
| 2 | 2000ms | 600ms | 2000-2600ms |
| 3 | 4000ms | 1200ms | 4000-5200ms |

### Environment Variables
- `BACKOFF_BASE_DELAY_MS` - Override base delay
- `BACKOFF_MAX_DELAY_MS` - Override max delay
- `BACKOFF_MULTIPLIER` - Override multiplier (1-10)
- `BACKOFF_JITTER_RATIO` - Override jitter ratio (0-1)
- `BACKOFF_MAX_ATTEMPTS` - Override max attempts

### Acceptance Criteria Met
- ✅ Implement exponential backoff with jitter for retryable errors
- ✅ Stage-specific backoff configurations for optimal retry behavior
- ✅ Integration with error taxonomy (isRetryable function support)
- ✅ Retry-After header support for HTTP 429 responses
- ✅ Detailed attempt tracking for observability

### Tests
- All 64 new tests pass
- All existing tests pass (632 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Limit retry attempts per stage and log outcomes

### Summary
Implemented comprehensive retry outcome tracking and logging for the ingestion pipeline. The implementation includes outcome classification (success/failure types), structured logging, outcome statistics, and enhanced retry execution with automatic logging support.

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `RetryOutcome` enum with 5 outcome types:
     - `SUCCESS_NO_RETRY` - Succeeded on first attempt
     - `SUCCESS_AFTER_RETRY` - Succeeded after one or more retries
     - `FAILURE_NON_RETRYABLE` - Failed with non-retryable error
     - `FAILURE_MAX_RETRIES_EXHAUSTED` - Failed after exhausting all retry attempts
     - `SKIPPED` - Operation was skipped
   - Added `RetryOutcomeLog` interface for structured logging with timestamp, stage, outcome, attempts, timing, context (resourceId, tenantId, runId), error info, and attempt summaries
   - Added `RetryOutcomeLogConfig` interface for logging configuration (includeAttemptDetails, logSuccesses, minAttemptsToLogSuccess)
   - Added `RetryOutcomeStats` interface for aggregated metrics
   - Added helper functions:
     - `getDefaultRetryOutcomeLogConfig()` - Returns default log configuration
     - `classifyRetryOutcome()` - Classifies retry result into outcome type
     - `createRetryOutcomeLog()` - Creates structured log entry from retry result
     - `shouldLogRetryOutcome()` - Determines if log should be written based on config
     - `formatRetryOutcomeLog()` - Formats log for human-readable output
     - `createStructuredRetryLog()` - Creates JSON-compatible log object
     - `isMaxRetriesReached()` - Checks if stage retry limit reached
     - `getRemainingRetries()` - Gets remaining retry attempts for stage
     - `executeWithRetryLogging()` - Enhanced retry execution with automatic logging
     - `summarizeRetryOutcomes()` - Aggregates outcome logs into statistics
   - Re-exported `STAGE_MAX_RETRIES` for convenience

2. **packages/shared/src/types/retry-outcome-logging.test.ts** (new file)
   - Added 77 tests covering:
     - RetryOutcome enum validation
     - Default log configuration
     - Outcome classification for all scenarios
     - Log creation with all fields
     - Log filtering based on config
     - Human-readable and structured log formatting
     - isMaxRetriesReached for all stages
     - getRemainingRetries calculations
     - executeWithRetryLogging integration
     - Outcome summarization statistics
     - Integration tests for complete workflows

### Key Design Decisions
- **Outcome Classification**: Clear distinction between non-retryable failures (permanent errors) and max retries exhausted (transient errors that persisted)
- **Structured Logging**: All logs include stage, timestamp, and context for easy filtering and aggregation
- **Configurable Verbosity**: Can suppress success logs or set minimum attempt threshold to reduce noise
- **Per-attempt Details**: Optional detailed tracking of each attempt for debugging
- **Statistic Aggregation**: Built-in support for summarizing outcomes across batches

### Retry Limits by Stage
| Stage | Max Retries | Rationale |
|-------|-------------|-----------|
| discover | 2 | URL discovery, network errors |
| fetch | 3 | HTTP fetching, rate limiting |
| extract | 2 | Content parsing, transient issues |
| chunk | 1 | Memory-bound, rarely needs retry |
| embed | 3 | API rate limits common |
| index | 3 | Database contention possible |

### Outcome Log Structure
```typescript
{
  timestamp: string;
  stage: IngestionStage;
  outcome: RetryOutcome;
  totalAttempts: number;
  maxAttempts: number;
  totalWaitTimeMs: number;
  totalExecutionTimeMs: number;
  resourceId?: string;
  tenantId?: string;
  runId?: string;
  error?: {
    code: string;
    category: string;
    message: string;
    retryable: boolean;
  };
  attemptSummary?: {
    attempt: number;
    succeeded: boolean;
    delayBeforeMs: number;
    durationMs?: number;
    errorCode?: string;
  }[];
}
```

### Acceptance Criteria Met
- ✅ Limit retry attempts per stage (using STAGE_MAX_RETRIES)
- ✅ Log outcomes for all retry operations (via RetryOutcomeLog)
- ✅ Classify outcomes (success, failure types)
- ✅ Support structured and human-readable logging
- ✅ Provide statistics aggregation for monitoring

### Tests
- All 77 new tests pass
- All existing tests pass (677 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Use deterministic embed job IDs based on chunk IDs

### Summary
Implemented deterministic embed job ID generation based on chunk IDs. This replaces the previous timestamp-based job IDs (`embed-{kbId}-{Date.now()}`) with deterministic hash-based IDs (`embed-{kbId}-{hash}`). The hash is derived from sorted chunk IDs, ensuring that:
1. Same chunks always produce the same job ID (idempotent re-queuing)
2. BullMQ will deduplicate jobs with the same ID automatically
3. Job IDs are predictable for better tracking and debugging

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `DeterministicEmbedJobIdConfig` interface - Configuration for job ID generation (prefix, hashLength, includeKbId)
   - Added `DeterministicEmbedJobIdResult` interface - Result type with jobId, sortedChunkIds, hash, chunkCount
   - Added `DEFAULT_EMBED_JOB_ID_CONFIG` constant - Default configuration values
   - Added `hashChunkIds()` - Generates deterministic hash from sorted chunk IDs using djb2 algorithm with BigInt
   - Added `generateDeterministicEmbedJobId()` - Main function to generate job IDs from KB ID and chunk IDs
   - Added `isValidDeterministicEmbedJobId()` - Validates job ID format
   - Added `parseDeterministicEmbedJobId()` - Extracts KB ID and hash from job ID
   - Added `wouldProduceSameEmbedJobId()` - Checks if two chunk sets would produce same job ID

2. **packages/queue/src/index.ts**
   - Updated `addEmbedChunksBatchJob()` to use `generateDeterministicEmbedJobId()` instead of timestamp-based ID
   - Added re-exports of all new types and helper functions

3. **packages/shared/src/types/deterministic-embed-job-id.test.ts** (new file)
   - Added 55 tests covering all new functionality:
     - Default config validation
     - Hash determinism and ordering independence
     - Job ID generation with various configurations
     - Validation and parsing functions
     - Edge cases (empty arrays, large batches, custom configs)
     - Integration tests for round-trip operations

### Key Design Decisions
- **djb2 hash algorithm**: Uses a fast, synchronous hash algorithm (djb2 variant) with BigInt to avoid JavaScript number overflow. The algorithm produces consistent 16-character hex strings.
- **Sorted chunk IDs**: Chunk IDs are sorted before hashing to ensure order-independent determinism.
- **Configurable options**: Supports custom prefix, hash length, and optional KB ID inclusion for flexibility.
- **BullMQ compatibility**: Job IDs contain only alphanumeric characters and dashes, safe for Redis keys.

### Job ID Format
| Component | Example | Description |
|-----------|---------|-------------|
| Old format | `embed-{kbId}-1705596000000` | Timestamp-based, non-deterministic |
| New format | `embed-{kbId}-abc123def456` | Hash-based, deterministic |

### Hash Algorithm
```
Input: [chunk3, chunk1, chunk2]
Step 1: Sort -> [chunk1, chunk2, chunk3]
Step 2: Join with delimiter -> "chunk1|chunk2|chunk3"
Step 3: Apply djb2 hash with BigInt
Step 4: Convert to 16-char hex string
Output: "abc123def4567890"
```

### Benefits
- **Idempotency**: Re-processing the same chunks won't create duplicate jobs
- **Deduplication**: BullMQ automatically prevents duplicate job IDs
- **Debuggability**: Same chunks always produce same job ID for easier tracking
- **Collision resistance**: 64-bit hash space with 16-char hex representation

### Acceptance Criteria Met
- ✅ Use deterministic embed job IDs based on chunk IDs
- ✅ Same chunks always produce same job ID
- ✅ Different chunks produce different job IDs
- ✅ Job IDs are BullMQ-compatible

### Tests
- All 55 new tests pass
- All existing tests pass (732 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Track per-chunk embed status and gate run completion

### Summary
Implemented per-chunk embedding status tracking using Redis and added embedding completion gating to the source run finalization process. This enables accurate tracking of which chunks have been embedded, which failed, and whether all embeddings completed before marking a run as finished.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `CHUNK_EMBED_STATUS_KEY_PREFIX` ("chunk_embed_status:") - Redis key prefix for status tracking
   - Added `CHUNK_EMBED_STATUS_KEY_TTL_SECONDS` (86400) - 24-hour TTL for status keys
   - Added `CHUNK_EMBED_FAILED_SET_KEY_PREFIX` ("chunk_embed_failed:") - Redis set prefix for failed chunk tracking
   - Added `EMBED_COMPLETION_GATING_DISABLED_ENV_VAR` - Environment variable to disable gating
   - Added `DEFAULT_EMBED_COMPLETION_WAIT_MS` (30000) - Default wait time for embedding completion
   - Added `EMBED_COMPLETION_CHECK_INTERVAL_MS` (2000) - Interval between completion checks
   - Added `EMBED_COMPLETION_ENV_VARS` - Object with all related env var names

2. **packages/shared/src/types/index.ts**
   - Added `ChunkEmbedStatus` enum with 5 states: PENDING, IN_PROGRESS, SUCCEEDED, FAILED_RETRYABLE, FAILED_PERMANENT
   - Added `ChunkEmbedStatusRecord` interface - Full status record with chunkId, status, runId, kbId, timestamps, error info, and dimensions
   - Added `ChunkEmbedStatusSummary` interface - Aggregated counts for monitoring
   - Added `EmbedCompletionGatingConfig` interface - Configuration for gating behavior
   - Added `EmbedCompletionCheckResult` interface - Result of completion check with counts and suggested status
   - Added helper functions:
     - `buildChunkEmbedStatusKey()` - Builds Redis key for chunk status
     - `buildChunkEmbedFailedSetKey()` - Builds Redis key for failed chunk set
     - `createPendingChunkEmbedStatus()` - Creates initial pending status record
     - `createInProgressChunkEmbedStatus()` - Creates in-progress status record
     - `createSucceededChunkEmbedStatus()` - Creates succeeded status record
     - `createFailedChunkEmbedStatus()` - Creates failed status record with error details
     - `calculateChunkEmbedStatusSummary()` - Calculates summary from status records
     - `isChunkEmbedInProgress()` - Checks if chunk is still being processed
     - `isChunkEmbedTerminal()` - Checks if chunk reached terminal state
     - `isChunkEmbedFailed()` - Checks if chunk failed (retryable or permanent)
     - `determineRunStatusFromEmbedding()` - Determines suggested run status based on embedding results
     - `resolveEmbedCompletionGatingConfig()` - Resolves gating config from environment

3. **packages/queue/src/index.ts**
   - Added `initializeChunkEmbedStatuses()` - Initializes pending status for all chunks before embedding
   - Added `getChunkEmbedStatus()` - Gets status for a single chunk
   - Added `getChunkEmbedStatuses()` - Gets status for multiple chunks
   - Added `markChunksEmbedInProgress()` - Marks chunks as in-progress
   - Added `markChunksEmbedSucceeded()` - Marks chunks as successfully embedded
   - Added `markChunksEmbedFailed()` - Marks chunks as failed with error details
   - Added `getFailedChunkIds()` - Gets list of failed chunk IDs from Redis set
   - Added `getRunPendingEmbedCount()` - Counts chunks still pending embedding
   - Added `getRunChunkEmbedSummary()` - Gets full summary of chunk statuses
   - Added `checkRunEmbeddingCompletion()` - Single check of embedding completion
   - Added `waitForRunEmbeddingCompletion()` - Polling wait for embedding completion
   - Added `cleanupChunkEmbedStatuses()` - Cleans up Redis keys after run completion
   - Re-exported all new types and constants

4. **apps/ingestion-worker/src/processors/embed-chunks.ts**
   - Added import for status tracking functions
   - Added `markChunksEmbedInProgress()` at job start to track embedding lifecycle
    - Added `markChunksEmbedSucceeded()` on successful embedding

## 2026-01-20: Implement regression detection for test suite runs

### Summary
Added regression detection logic to compare completed test runs and identify pass rate drops or newly failing cases.

### Changes Made
1. **apps/api/src/services/test-runner.ts**
   - Added regression detection helpers (`checkForRegression`, `calculatePassRate`, `findNewlyFailingCases`)
   - Extended test runner store with regression queries for previous runs and case results
   - Invoked regression detection after completed runs with logging on regression

2. **apps/api/src/services/test-runner.test.ts**
   - Added regression detection unit tests for pass rate drops, newly failing cases, and disabled alerts

### Tests
- `bun test apps/api/src/services/test-runner.test.ts`
   - Added `markChunksEmbedFailed()` for various error scenarios:
     - KB not found (non-retryable)
     - Chunks not found (non-retryable)
     - Embedding dimension mismatch (non-retryable)
     - Vector store not configured (non-retryable)
     - Generic errors (retryable)

5. **apps/ingestion-worker/src/processors/page-process.ts**
   - Added import for `initializeChunkEmbedStatuses`
   - Added call to initialize chunk status before queuing embed job

6. **apps/ingestion-worker/src/processors/source-finalize.ts**
   - Added imports for embedding completion functions
   - Added embedding completion gating logic:
     - Checks if gating is enabled and chunks need embedding
     - Waits for embedding completion with configurable timeout
     - Determines final run status based on embedding results
   - Added cleanup of chunk embed status Redis keys after finalization
   - Logs incomplete embeddings as warnings

7. **packages/shared/src/types/chunk-embed-status.test.ts** (new file)
   - Added 59 tests covering all new functionality:
     - ChunkEmbedStatus enum validation
     - Key building functions
     - Status record creation functions
     - Summary calculation
     - Status checking functions (isInProgress, isTerminal, isFailed)
     - Run status determination from embedding results
     - Gating configuration resolution

### Key Design Decisions
- **Redis-based tracking**: Uses Redis for per-chunk status to avoid database overhead and enable fast lookups
- **TTL-based cleanup**: Status keys have 24-hour TTL as backup, explicit cleanup on run completion
- **Failed chunk set**: Separate Redis set tracks failed chunk IDs for efficient lookup
- **Gating configurable**: Embedding completion gating can be disabled via environment variable
- **Suggested status**: Completion check returns suggested run status (succeeded, partial, failed, embedding_incomplete)
- **Error categorization**: Failed statuses include error code and retryable flag for debugging

### Status Lifecycle
```
PENDING -> IN_PROGRESS -> SUCCEEDED
                      -> FAILED_RETRYABLE
                      -> FAILED_PERMANENT
```

### Redis Key Patterns
- Status: `chunk_embed_status:{runId}:{chunkId}`
- Failed set: `chunk_embed_failed:{runId}`

### Environment Variables
- `EMBED_COMPLETION_GATING_DISABLED` - Set to "true" or "1" to disable gating
- `EMBED_COMPLETION_WAIT_MS` - Override max wait time (default 30000ms)
- `EMBED_COMPLETION_CHECK_INTERVAL_MS` - Override check interval (default 2000ms)

### Acceptance Criteria Met
- ✅ Track per-chunk embed status with Redis-based storage
- ✅ Gate run completion on embedding completion
- ✅ Add embedding_incomplete run status handling
- ✅ Cleanup tracking data after run finalization
- ✅ Configurable gating behavior via environment variables

### Tests
- All 59 new tests pass
- All existing tests pass (791 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Implement robots.txt enforcement with override flag

### Summary
Implemented robots.txt enforcement for the URL discovery stage of the ingestion pipeline. The system fetches and parses robots.txt files, caches them in Redis, and filters URLs based on Disallow/Allow rules. The feature respects the per-source `respectRobotsTxt` configuration flag (default: true) and can be globally disabled via environment variable.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `ROBOTS_USER_AGENT` ("Grounded-Bot") - User agent for matching rules
   - Added `ROBOTS_WILDCARD_USER_AGENT` ("*") - Fallback user agent
   - Added `ROBOTS_TXT_CACHE_TTL_SECONDS` (3600) - 1 hour cache TTL
   - Added `ROBOTS_TXT_CACHE_KEY_PREFIX` ("robots_txt_cache:") - Redis key prefix
   - Added `ROBOTS_TXT_FETCH_TIMEOUT_MS` (5000) - 5 second fetch timeout
   - Added `ROBOTS_TXT_DISABLED_ENV_VAR` - Global disable flag
   - Added `ROBOTS_TXT_DEBUG_ENV_VAR` - Debug logging flag

2. **packages/shared/src/types/index.ts**
   - Added `RobotsTxtRule` interface - Single Allow/Disallow rule
   - Added `RobotsTxtUserAgentGroup` interface - User-agent section with rules
   - Added `ParsedRobotsTxt` interface - Full parsed robots.txt structure
   - Added `RobotsTxtCheckResult` interface - URL check result
   - Added `RobotsTxtEnforcementConfig` interface - Configuration options
   - Added `RobotsTxtStats` interface - Statistics for monitoring
   - Added helper functions:
     - `isRobotsTxtGloballyDisabled()` - Checks global disable env var
     - `isRobotsTxtDebugEnabled()` - Checks debug logging env var
     - `getDefaultRobotsTxtConfig()` - Returns default configuration
     - `buildRobotsTxtCacheKey()` - Builds Redis cache key
     - `getRobotsTxtCacheTtl()` / `getRobotsTxtFetchTimeout()` - Config getters
     - `buildRobotsTxtUrl()` - Builds robots.txt URL from any page URL
     - `extractDomainForRobots()` - Extracts domain from URL
     - `parseRobotsTxt()` - Parses robots.txt content into structured format
     - `createRobotsTxtError()` - Creates error result for fetch failures
     - `createRobotsTxtNotFound()` - Creates result for 404 (allows all)
     - `matchRobotsTxtPattern()` - Matches URL against robots.txt pattern
     - `findRobotsTxtGroup()` - Finds applicable user-agent group
     - `checkUrlAgainstRobotsTxt()` - Checks if URL is allowed
     - `filterUrlsByRobotsTxt()` - Filters URL list by robots.txt
     - `createEmptyRobotsTxtStats()` / `updateRobotsTxtStats()` - Stats helpers
   - Updated `createRobotsBlockedSkipDetails()` to include matched rule and user agent

3. **apps/ingestion-worker/src/processors/source-discover.ts**
   - Added in-memory robots.txt cache for current process
   - Added `fetchRobotsTxt()` - Fetches and caches robots.txt from Redis/network
   - Added `cacheRobotsTxt()` - Caches parsed robots.txt in memory and Redis
   - Added `filterUrlsByRobotsRules()` - Filters URLs by robots.txt, grouping by domain
   - Updated `processSourceDiscover()` to:
     - Check `config.respectRobotsTxt` flag (defaults to true)
     - Filter URLs through robots.txt rules after pattern filtering
     - Log blocked URLs at info level with counts
     - Log individual blocked URLs at debug level with reasons

4. **packages/shared/src/types/robots-txt-enforcement.test.ts** (new file)
   - Added 79 tests covering:
     - All constants validation
     - Environment variable handling
     - Configuration functions
     - Cache key building
     - URL building and domain extraction
     - robots.txt parsing (basic, complex, wildcards, comments)
     - Pattern matching (prefix, wildcards, end-of-URL $)
     - User-agent group finding (exact, substring, wildcard fallback)
     - URL checking (allow/disallow, specificity, enforcement)
     - URL filtering
     - Statistics tracking
     - Skip details creation
     - Real-world robots.txt examples (Google-style, bot-specific rules)
     - Interface compliance tests

### Key Design Decisions
- **Respect by default**: `respectRobotsTxt: true` in SourceConfig schema
- **Global override**: Can be disabled via `ROBOTS_TXT_DISABLED=true` env var
- **Per-source override**: Each source can set `respectRobotsTxt: false` to ignore robots.txt
- **Fail-open**: If robots.txt fetch fails or is invalid, allow all URLs (safe default)
- **Caching**: 1-hour TTL in both in-memory and Redis caches
- **Specificity**: More specific patterns (longer) take precedence over general ones
- **Empty Disallow**: Empty `Disallow:` pattern means "allow all" per robots.txt spec

### Robots.txt Features Supported
| Feature | Support |
|---------|---------|
| User-agent matching | ✅ Exact, substring, wildcard (*) |
| Disallow rules | ✅ Path prefix matching |
| Allow rules | ✅ Path prefix matching |
| Wildcards (*) | ✅ In patterns |
| End-of-URL ($) | ✅ Exact path matching |
| Crawl-delay | ✅ Parsed (not enforced) |
| Sitemap | ✅ Parsed and stored |
| Multiple groups | ✅ User-agent specific rules |
| Comments (#) | ✅ Inline and full-line |

### Configuration Options
| Setting | Default | Override |
|---------|---------|----------|
| Enforcement enabled | true | `ROBOTS_TXT_DISABLED=true` |
| Per-source enabled | true | `source.config.respectRobotsTxt = false` |
| User agent | "Grounded-Bot" | - |
| Cache TTL | 3600s (1 hour) | - |
| Fetch timeout | 5000ms (5 seconds) | - |
| Debug logging | false | `ROBOTS_TXT_DEBUG=true` |

### Acceptance Criteria Met
- ✅ Implement robots.txt enforcement with override flag
- ✅ Fetch and parse robots.txt files
- ✅ Cache robots.txt in Redis with TTL
- ✅ Filter URLs based on Disallow/Allow rules
- ✅ Support per-source `respectRobotsTxt` configuration
- ✅ Support global disable via environment variable
- ✅ Handle wildcards and end-of-URL patterns
- ✅ Fail-open on fetch errors (allow all URLs)

### Tests
- All 79 new tests pass
- All existing tests pass (879 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Log robots override usage and blocked URLs

### Summary
Implemented structured logging for robots.txt override usage and blocked URLs. The system now logs detailed information when robots.txt enforcement is bypassed (either globally or per-source) and provides comprehensive summary logs for blocked URLs during URL discovery.

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `RobotsOverrideType` enum with two values: `SOURCE_OVERRIDE` and `GLOBAL_DISABLED`
   - Added `RobotsOverrideLog` interface for tracking override events with type, timestamp, IDs, URL/domain counts, and reason
   - Added `RobotsBlockedUrlLog` interface for individual blocked URL logs with URL, domain, rule, and user agent
   - Added `RobotsBlockedSummaryLog` interface for aggregated summary logs with domain breakdown and sample URLs
   - Added `RobotsLoggingConfig` interface for configurable logging behavior
   - Added helper functions:
     - `getDefaultRobotsLoggingConfig()` - Returns default logging configuration
     - `createRobotsOverrideLog()` - Creates structured override log entry
     - `createRobotsBlockedUrlLog()` - Creates individual blocked URL log entry
     - `createRobotsBlockedSummaryLog()` - Creates summary log with domain breakdown
     - `formatRobotsOverrideLog()` - Human-readable override log format
     - `formatRobotsBlockedUrlLog()` - Human-readable blocked URL format
     - `formatRobotsBlockedSummaryLog()` - Human-readable summary format
     - `createStructuredRobotsOverrideLog()` - JSON-compatible override log object
     - `createStructuredRobotsBlockedSummaryLog()` - JSON-compatible summary with block rate
     - `shouldLogRobotsOverride()` - Config-based override logging decision
     - `shouldLogIndividualBlocks()` - Config-based individual block logging decision

2. **apps/ingestion-worker/src/processors/source-discover.ts**
   - Added `RobotsFilterResult` interface to track override usage
   - Updated `filterUrlsByRobotsRules()` to return override information (type and whether used)
   - Added override logging when robots.txt enforcement is bypassed
   - Added summary logging for all robots.txt filtering operations
   - Logs include structured JSON data for observability tools

3. **packages/shared/src/types/robots-override-logging.test.ts** (new file)
   - Added 57 tests covering:
     - RobotsOverrideType enum validation
     - Default logging configuration
     - Override log creation (global and per-source)
     - Blocked URL log creation
     - Summary log creation with domain breakdown
     - Human-readable formatting for all log types
     - Structured JSON log creation
     - Config-based logging decisions
     - Integration tests for complete workflows
     - Type compliance tests

### Key Design Decisions
- **Structured logging**: All logs include structured data for easy parsing by observability tools
- **Summary over individual**: Default configuration logs summaries rather than individual URLs to reduce noise
- **Domain breakdown**: Summary logs include blocked count per domain for debugging
- **Sample URLs**: Summary includes configurable sample of blocked URLs for debugging
- **Block rate calculation**: Structured summary includes percentage of URLs blocked
- **Configurable verbosity**: Logging behavior can be customized via RobotsLoggingConfig

### Log Types
| Log Type | Purpose | Default Enabled |
|----------|---------|-----------------|
| Override | When robots.txt is bypassed | Yes |
| Summary | Aggregated blocking stats | Yes |
| Individual | Per-URL blocking details | No (too noisy) |

### Structured Log Fields
**Override Log:**
- `event: "robots_override"`
- `overrideType`: "source_override" or "global_disabled"
- `runId`, `sourceId`, `tenantId`
- `urlCount`, `domainCount`, `domains`
- `reason`: Human-readable explanation

**Summary Log:**
- `event: "robots_blocked_summary"`
- `totalUrlsChecked`, `totalUrlsBlocked`
- `domainsWithBlocks`, `blockedByDomain`
- `sampleBlockedUrls`: First N blocked URLs
- `robotsTxtRespected`: Whether enforcement was active
- `blockRate`: Percentage of URLs blocked

### Acceptance Criteria Met
- ✅ Log robots override usage (global and per-source)
- ✅ Log blocked URLs with domain breakdown
- ✅ Structured logging for observability tools
- ✅ Human-readable formatting available
- ✅ Configurable logging verbosity

### Tests
- All 57 new tests pass
- All existing tests pass (936 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Emit per-stage throughput and latency metrics

### Summary
Implemented comprehensive per-stage throughput and latency metrics for the ingestion pipeline. The system enables collecting, aggregating, and emitting metrics for each pipeline stage (discover, fetch, extract, chunk, embed, index), with support for real-time accumulation, worker merging, and structured logging.

### Changes Made
1. **packages/shared/src/constants/index.ts**
   - Added `DEFAULT_METRICS_EMIT_INTERVAL_MS` (30000) - Default interval for emitting periodic metrics
   - Added `METRICS_EMIT_INTERVAL_ENV_VAR` - Environment variable to override emit interval
   - Added `METRICS_DISABLED_ENV_VAR` - Environment variable to disable metrics entirely
   - Added `STAGE_METRICS_KEY_PREFIX` ("stage_metrics:") - Redis key prefix for storing metrics
   - Added `STAGE_METRICS_KEY_TTL_SECONDS` (86400) - 24-hour TTL for metrics keys
   - Added `STAGE_METRICS_ENV_VARS` - Object with all metrics-related env var names

2. **packages/shared/src/types/index.ts**
   - Added `StageLatencyStats` interface - Tracks min/max/sum/count/average latency
   - Added `StageThroughputMetrics` interface - Items completed/failed/skipped, success rate, throughput/s
   - Added `StageLatencyMetrics` interface - Min/max/average latency, total duration, sample count
   - Added `StageMetrics` interface - Combined throughput and latency with wall clock timing
   - Added `StageItemTiming` interface - Per-item timing record with outcome and error tracking
   - Added `RunStageMetricsAccumulator` interface - In-memory accumulator for a run
   - Added `StageMetricsData` interface - Internal data structure for per-stage accumulation
   - Added `StageMetricsSnapshot` interface - Point-in-time metrics snapshot for logging
   - Added `RunMetricsSummary` interface - Complete run summary with critical path and bottleneck detection
   - Added `StageMetricsConfig` interface - Configuration with enabled/interval/debug settings
   - Added `StageMetricsLog` interface - Structured log entry for stage metrics
   - Added helper functions:
     - `isStageMetricsDisabled()` - Checks if metrics are disabled via env var
     - `isStageMetricsDebugEnabled()` - Checks if debug logging is enabled
     - `getStageMetricsEmitInterval()` - Gets emit interval from env or default
     - `getStageMetricsConfig()` - Gets full config from environment
     - `buildStageMetricsKey()` - Builds Redis key for stage metrics
     - `getStageMetricsKeyTtl()` - Gets TTL for metrics keys
     - `createEmptyLatencyStats()` - Creates empty latency stats object
     - `createEmptyStageMetricsData()` - Creates empty stage data object
     - `createRunStageMetricsAccumulator()` - Creates accumulator for a run
     - `updateLatencyStats()` - Updates latency stats with new sample
     - `recordItemTiming()` - Records item timing into accumulator
     - `createStageItemTiming()` - Creates timing record with duration calculation
     - `calculateThroughputMetrics()` - Calculates throughput from stage data
     - `calculateLatencyMetrics()` - Calculates latency from stage data
     - `calculateStageMetrics()` - Calculates combined metrics
     - `createStageMetricsSnapshot()` - Creates snapshot from accumulator
     - `createRunMetricsSummary()` - Creates complete run summary
     - `createStageMetricsLog()` - Creates structured log entry
     - `formatStageMetricsLog()` - Formats log for human readability
     - `createStructuredRunMetricsLog()` - Creates JSON-compatible summary log
     - `mergeStageMetricsData()` - Merges metrics from multiple workers
     - `serializeStageMetricsData()` - Serializes for Redis storage
     - `deserializeStageMetricsData()` - Deserializes from Redis storage

3. **packages/shared/src/types/stage-metrics.test.ts** (new file)
   - Added 67 tests covering all new types, constants, and functions
   - Tests validate configuration resolution from environment
   - Tests cover latency stats accumulation and aggregation
   - Tests cover throughput and success rate calculations
   - Tests cover snapshot and summary creation
   - Tests cover structured logging and human-readable formatting
   - Tests cover metrics merging for distributed workers
   - Tests cover serialization/deserialization round-trips
   - Tests include integration scenarios for complete pipeline processing

### Key Design Decisions
- **In-memory accumulation**: Metrics are accumulated in-memory per-run for performance
- **Wall clock vs processing time**: Tracks both individual item durations and overall wall clock time
- **Critical path detection**: Summary identifies stages sorted by latency (slowest first)
- **Bottleneck detection**: Summary identifies stage with lowest throughput
- **Worker merging**: Support for merging metrics from distributed workers
- **Redis persistence**: Stage metrics can be stored in Redis for cross-process aggregation
- **Configurable**: Metrics can be disabled, emit interval can be customized via env vars

### Metrics Collected
| Metric | Description |
|--------|-------------|
| itemsCompleted | Successfully processed items |
| itemsFailed | Failed items |
| itemsSkipped | Skipped items |
| successRate | Percentage of successful items (0-100) |
| throughputPerSecond | Items completed per second |
| minLatencyMs | Minimum processing time |
| maxLatencyMs | Maximum processing time |
| averageLatencyMs | Average processing time |
| totalDurationMs | Sum of all processing times |
| wallClockDurationMs | Time from first item start to last item complete |

### Environment Variables
- `STAGE_METRICS_DISABLED` - Set to "true" or "1" to disable metrics
- `METRICS_EMIT_INTERVAL_MS` - Override periodic emit interval (default 30000ms)
- `STAGE_METRICS_DEBUG` - Set to "true" or "1" to enable debug logging

### Structured Log Format
```typescript
{
  event: "stage_metrics",
  stage: "fetch",
  runId: "run-123",
  sourceId: "src-456",
  tenantId: "tenant-789",
  timestamp: "2024-01-01T10:00:00.000Z",
  isFinal: true,
  itemsCompleted: 100,
  itemsFailed: 5,
  itemsSkipped: 2,
  totalItems: 107,
  successRate: 93.46,
  throughputPerSecond: 8.5,
  minLatencyMs: 50,
  maxLatencyMs: 5000,
  averageLatencyMs: 850,
  totalDurationMs: 91000,
  wallClockDurationMs: 12500
}
```

### Acceptance Criteria Met
- ✅ Emit per-stage throughput and latency metrics
- ✅ Track items completed, failed, and skipped per stage
- ✅ Calculate success rate and throughput
- ✅ Track min/max/average latency per stage
- ✅ Support merging metrics from multiple workers
- ✅ Provide structured logging for observability
- ✅ Configurable via environment variables

### Tests
- All 67 new tests pass
- All existing tests pass (1003 tests in shared package)
- TypeScript typechecking passes across all packages

## 2026-01-18: Add run summary logs with error breakdown and skip counts

### Summary
Implemented comprehensive run summary logging for the ingestion pipeline. The system now generates detailed run summaries upon finalization that include error breakdown by error code, skip counts by reason, embedding statistics, and per-stage summaries. This enables better observability into run outcomes and helps identify patterns in failures.

### Changes Made
1. **packages/shared/src/types/index.ts**
   - Added `ErrorBreakdownEntry` interface - Tracks count and sample URLs for each error code
   - Added `SkipBreakdownEntry` interface - Tracks count and sample URLs for each skip reason
   - Added `StageSummary` interface - Per-stage summary with completed/failed/skipped counts
   - Added `RunSummaryLog` interface - Complete run summary with all breakdown data
   - Added `RunSummaryLoggingConfig` interface - Configuration for summary logging behavior
   - Added `RunSummaryInput` interface - Input data for creating run summaries
   - Added `StructuredRunSummaryLog` interface - Extended summary with level and service for JSON logging
   - Added helper functions:
     - `getDefaultRunSummaryLoggingConfig()` - Returns default logging configuration
     - `getSkipReasonDescription()` - Maps skip reason to human-readable description
     - `getSkipReasonStage()` - Maps skip reason to ingestion stage
     - `parseErrorCodeFromMessage()` - Extracts error code from error message text
     - `getErrorCategoryFromCode()` - Gets error category from error code (now exported)
     - `isErrorCodeRetryable()` - Determines if error code is retryable
     - `buildErrorBreakdown()` - Aggregates failed pages into error breakdown
     - `buildSkipBreakdown()` - Aggregates skipped pages into skip breakdown
     - `buildStageSummaries()` - Creates per-stage summaries from metrics
     - `createRunSummaryLog()` - Creates complete run summary from input data
     - `getRunSummaryLogLevel()` - Determines appropriate log level (info/warn/error)
     - `createStructuredRunSummaryLog()` - Creates JSON-compatible structured log
     - `formatRunSummaryLog()` - Formats summary for human-readable output
     - `shouldLogRunSummary()` - Determines if summary should be logged based on config
     - `createCompactRunSummary()` - Creates one-line compact summary string

2. **apps/ingestion-worker/src/processors/source-finalize.ts**
   - Added import for run summary types and functions
   - Added collection of skipped pages from PostgreSQL data with skip details
   - Added creation of `RunSummaryInput` with all available data
   - Added generation of run summary log at appropriate level (error/warn/info)
   - Added logging of detailed error breakdown when failures exist
   - Added logging of detailed skip breakdown when skips exist
   - Logs include compact summary for quick scanning and full structured data for querying

3. **packages/shared/src/types/run-summary-logging.test.ts** (new file)
   - Added 107 tests covering:
     - Default configuration values
     - Skip reason descriptions and stages
     - Error code parsing from messages (timeout, connection, DNS, SSL, rate limit, etc.)
     - Error category extraction
     - Error code retryability classification
     - Error breakdown building
     - Skip breakdown building
     - Stage summary building
     - Run summary log creation
     - Log level determination
     - Structured log creation
     - Human-readable formatting
     - Compact summary creation
     - Logging decision logic
     - Interface compliance tests
     - Complete integration tests for various run scenarios

### Key Design Decisions
- **Comprehensive error parsing**: `parseErrorCodeFromMessage()` recognizes 35+ error patterns from message text
- **Ordered pattern matching**: More specific patterns (like "GATEWAY TIMEOUT") checked before general ones (like "TIMEOUT")
- **Sample URLs**: Error and skip breakdowns include sample URLs (configurable limit) for debugging
- **Multiple log levels**: Summary logged at error/warn/info based on outcome severity
- **Compact + detailed**: Both compact one-liner and full structured data logged for different use cases
- **Reuses existing types**: Uses existing `SkipReason`, `IngestionStage`, `PageSkipDetails` interfaces
- **Configurable verbosity**: Config controls stage breakdown, sample size, and logging thresholds

## 2026-01-19: Implement test runner core service

### Summary
Implemented the core test runner service with suite execution flow, Redis-backed locking, and run lifecycle updates.

### Changes Made
1. **apps/api/src/services/test-runner.ts**
   - Added runTestSuite and executeTestRun with queueing, lock renewal, and lifecycle updates
   - Implemented evaluation helpers, chat response collection, and per-case timeout handling
   - Added Redis lock manager and store abstraction for easier testing

2. **apps/api/src/services/test-runner.test.ts**
   - Added tests for missing suite handling, queueing behavior, and zero-case completion

### Run Summary Structure
```typescript
{
  event: "run_summary",
  runId, sourceId, tenantId, timestamp,
  finalStatus: "succeeded" | "partial" | "failed" | "embedding_incomplete",
  runDurationMs, runStartedAt, runFinishedAt,
  pages: { total, succeeded, failed, skipped, successRate },
  embeddings?: { chunksToEmbed, chunksEmbedded, chunksFailed, completionRate },
  errorBreakdown: [{ code, category, retryable, count, sampleUrls }],
  skipBreakdown: [{ reason, description, stage, count, sampleUrls }],
  stageSummaries?: [{ stage, completed, failed, skipped, total, successRate }],
  summary: {
    uniqueErrorCodes, uniqueSkipReasons,
    mostCommonError?, mostCommonSkip?,
    hasRetryableErrors, hasPermanentErrors
  }
}
```

### Compact Summary Format
```
status=partial | pages=80/100 | failed=10 | skipped=10 | duration=5.0s | embedded=480/500 | top_error=NETWORK_TIMEOUT(5) | top_skip=robots_blocked(3)
```

### Acceptance Criteria Met
- ✅ Add run summary logs with error breakdown and skip counts
- ✅ Group errors by error code with counts and sample URLs
- ✅ Group skips by reason with counts and sample URLs
- ✅ Include embedding completion statistics when applicable
- ✅ Log at appropriate level based on run outcome
- ✅ Structured logging for observability tools
- ✅ Human-readable formatting available

### Tests
- All 107 new tests pass
- All existing tests pass (1110 tests in shared package)
- TypeScript typechecking passes across all packages

2026-01-19 - Added agent test suite schema tables, exported them, and added schema tests (bun run --filter @grounded/db test).

## 2026-01-19: Implement test suite evaluation functions

### Summary
Added coverage for test suite evaluation helpers, including phrase checks, semantic similarity scoring, LLM judge parsing, and all/any aggregation.

### Changes Made
1. **apps/api/src/services/test-runner.ts**
   - Exported evaluation helpers for test coverage and aligned evaluation context typing.

2. **apps/api/src/services/test-runner-evaluations.test.ts** (new file)
   - Added tests for contains-phrases matching, semantic similarity thresholds, LLM judge JSON handling, and all/any aggregation.

### Tests
- `bun test apps/api/src/services/test-runner-evaluations.test.ts`

## 2026-01-20: Implement test case API routes and validation

### Summary
Added test case CRUD/reorder endpoints with ExpectedBehavior validation and last-result hydration for listing cases.

### Changes Made
1. **apps/api/src/routes/test-suites.ts**
   - Added expected behavior validation schemas and test case routes.
   - Implemented suite-scoped listing with last result lookups.
   - Added create, update, delete, and reorder endpoints for test cases.

2. **apps/api/src/index.ts**
   - Mounted `/api/v1/test-cases` routes.

3. **apps/api/src/routes/test-cases.test.ts** (new file)
   - Added schema tests for expected behavior and test case validation.

### Tests
- `bun test apps/api/src/routes/test-cases.test.ts`

## 2026-01-20: Implement test run API routes and suite analytics

### Summary
Added test run list/start/detail/cancel endpoints with pass rate calculations and per-suite analytics aggregation helpers.

### Changes Made
1. **apps/api/src/routes/test-suites.ts**
   - Added test run listing, start, detail, cancel/delete, and analytics endpoints.
   - Calculated pass rates for runs and analytics responses.

2. **apps/api/src/services/test-suite-metrics.ts** (new file)
   - Added helper functions for pass rate and regression counting.

3. **apps/api/src/services/test-suite-metrics.test.ts** (new file)
   - Added coverage for pass rate calculation and regression detection.

4. **apps/api/src/index.ts**
   - Mounted `/api/v1/test-runs` routes.

### Tests
- `bun test apps/api/src/services/test-suite-metrics.test.ts`

## 2026-01-20: Add JSONL import/export for test cases

### Summary
Implemented JSONL import and export endpoints for test cases with validation helpers and parsing tests.

### Changes Made
1. **apps/api/src/services/test-suite-import.ts** (new file)
   - Added JSONL parsing and serialization helpers with expected behavior validation.
   - Returns per-line error details and skipped counts for imports.

2. **apps/api/src/routes/test-suites.ts**
   - Added `/test-suites/:suiteId/import` and `/test-suites/:suiteId/export` endpoints.
   - Imports validated test cases with sequential sort ordering and exports JSONL downloads.

3. **apps/api/src/services/test-suite-import.test.ts** (new file)
   - Added tests for valid JSONL parsing, invalid line handling, and export round-trips.

### Tests
- `bun test apps/api/src/services/test-suite-import.test.ts`

## 2026-01-20: Implement test suite scheduler and retention cleanup

### Summary
Added a background scheduler for running test suites on hourly/daily/weekly schedules, plus nightly retention cleanup with configurable settings and admin controls.

### Changes Made
1. **apps/api/src/services/test-suite-scheduler.ts** (new file)
   - Added interval-based scheduler with Redis schedule-window reservations.
   - Implemented schedule logic, duplicate run prevention, and retention cleanup workflow.
   - Added retention settings resolution with env fallbacks and cleanup selection helpers.

2. **apps/api/src/index.ts**
   - Starts the test suite scheduler on API startup and stops on shutdown signals.

3. **apps/api/src/routes/admin/settings.ts**
   - Added retention settings metadata and admin endpoints for scheduler status/restart.

4. **packages/db/src/schema/tenants.ts**
   - Expanded system settings category type to include `test_suites`.

5. **apps/api/src/services/test-suite-scheduler.test.ts** (new file)
   - Added unit tests for schedule timing, retention cleanup selection, and window calculations.

### Tests
- `bun test apps/api/src/services/test-suite-scheduler.test.ts`

## 2026-01-20: Send regression alert emails for test suites

### Summary
Added regression alert email delivery for test suite runs with templates that highlight pass rate changes and newly failing cases.

### Changes Made
1. **apps/api/src/services/email.ts**
   - Added `sendTestRegressionAlert()` email template with pass rate summary and failing case list

2. **apps/api/src/services/test-runner.ts**
   - Added regression alert recipient resolution and run URL builder
   - Wired regression alerts into run completion handling

3. **apps/api/src/services/email.test.ts** (new file)
   - Added regression alert template test coverage

4. **.env.example**
   - Documented optional `APP_URL` for alert email links

### Tests
- `bun test apps/api/src/services/email.test.ts`

## 2026-01-20: Add test suite API client types

### Summary
Added frontend TypeScript types for agent test suite entities, expected behavior checks, and DTOs.

### Changes Made
1. **apps/web/src/lib/api/types.ts**
   - Added ExpectedBehavior and CheckResult types
   - Added TestSuite, TestCase, and TestSuiteRun models
   - Added result, analytics, and DTO type definitions

2. **apps/web/src/lib/api/test-suites.types.test.ts** (new file)
   - Added type-shape coverage for test suite entities and DTOs

### Tests
- `bun test apps/web/src/lib/api/test-suites.types.test.ts`

## 2026-01-20: Add test suite API client methods

### Summary
Implemented the frontend API client for test suites, including CRUD helpers, run analytics, and JSONL import/export support.

### Changes Made
1. **apps/web/src/lib/api/test-suites.ts**
   - Added suite, case, and run CRUD methods
   - Added import/export helpers with auth headers
   - Added analytics and run query helpers

2. **apps/web/src/lib/api/test-suites.test.ts**
   - Added export and parameter count tests for test suite API methods

3. **apps/web/src/lib/api/index.ts**
   - Registered test suites API in unified client exports

4. **apps/web/src/lib/api/api.test.ts**
   - Added test suite API export coverage

### Tests
- `bun test apps/web/src/lib/api/test-suites.test.ts apps/web/src/lib/api/api.test.ts`

## 2026-01-20: Create test suite cards and list UI

### Summary
Built TestSuiteCard and TestSuiteList components with schedule badges, last-run status, and empty/loading states for test suite management.

### Changes Made
1. **apps/web/src/components/test-suites/TestSuiteCard.tsx**
   - Added card layout with schedule badge, test count, and last-run status badge
   - Added helper functions for schedule labels, run status badges, and timestamps
   - Added hover actions for run, edit, and delete workflows

2. **apps/web/src/components/test-suites/TestSuiteList.tsx**
   - Added list layout with loading skeleton and empty state handling
   - Added default empty state copy and action support

3. **apps/web/src/components/test-suites/index.ts**
   - Exported new test suite components

4. **apps/web/src/components/test-suites/TestSuiteCard.test.ts** (new file)
   - Added helper function coverage for schedule labels and run status handling

5. **apps/web/src/components/test-suites/TestSuiteList.test.ts** (new file)
   - Added export checks and default empty state coverage

### Tests
- `bun test apps/web/src/components/test-suites/TestSuiteCard.test.ts apps/web/src/components/test-suites/TestSuiteList.test.ts`
