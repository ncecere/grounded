# Grounded Refactoring Progress

## 2026-01-17: Extract shared source CRUD + run helpers

### Completed Task
**Task:** Extract shared source CRUD + run helpers for sources and shared-kbs routes
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/source-helpers.ts`

2. **Extracted shared validation schemas:**
   - `createSourceBaseSchema` - Base schema for source creation
   - `createSourceWithKbIdSchema` - Schema with kbId for tenant sources
   - `updateSourceSchema` - Schema for partial source updates
   - `triggerRunSchema` - Schema for run trigger options

3. **Extracted shared helper functions:**
   - `buildSourceUpdateData()` - Merges partial config updates with existing config
   - `calculateSourceStats()` - Computes page count and chunk count for a source
   - `cascadeSoftDeleteSourceChunks()` - Soft-deletes all chunks for a source
   - `findRunningRun()` - Checks if a source has an active run
   - `createSourceRun()` - Creates a new source run record
   - `queueSourceRunJob()` - Queues a source run job for processing

4. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/sources.ts` - Tenant source routes
   - `apps/api/src/routes/admin/shared-kbs.ts` - Global KB source routes

5. **Added tests:**
   - `apps/api/src/services/source-helpers.test.ts` - 23 tests covering all schemas and helpers

### Code Reduction
- Eliminated ~100 lines of duplicate code between sources.ts and shared-kbs.ts
- Centralized validation schemas prevent drift between routes
- Stats calculation, cascade delete, and run management now use single implementations

### Files Changed
- `apps/api/src/services/source-helpers.ts` (NEW)
- `apps/api/src/services/source-helpers.test.ts` (NEW)
- `apps/api/src/routes/sources.ts` (MODIFIED)
- `apps/api/src/routes/admin/shared-kbs.ts` (MODIFIED)
- `apps/api/package.json` (MODIFIED - added test script)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Unify widget /chat and /chat/stream handlers

### Completed Task
**Task:** Unify widget /chat and /chat/stream handlers into a shared streaming function
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/widget-chat-helpers.ts`

2. **Extracted shared validation schema:**
   - `widgetChatSchema` - Schema for widget chat input (message + optional conversationId)

3. **Extracted shared helper functions:**
   - `validateWidgetToken()` - Validates widget token and returns associated agent
   - `checkWidgetRateLimit()` - Checks tenant rate limit for chat requests
   - `setSSEHeaders()` - Sets required headers for SSE streaming
   - `handleWidgetChatStream()` - Unified streaming handler for widget chat

4. **Updated routes to use shared handler:**
   - `apps/api/src/routes/widget.ts` - Both `/chat` and `/chat/stream` now use `handleWidgetChatStream()`

5. **Added tests:**
   - `apps/api/src/services/widget-chat-helpers.test.ts` - 11 tests covering validation schema

### Code Reduction
- Eliminated ~50 lines of duplicate code between /chat and /chat/stream handlers
- Centralized SSE header configuration
- Token validation and rate limiting now use single implementations
- Routes reduced from 172 lines to 66 lines

### Files Changed
- `apps/api/src/services/widget-chat-helpers.ts` (NEW)
- `apps/api/src/services/widget-chat-helpers.test.ts` (NEW)
- `apps/api/src/routes/widget.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Create reusable agent ownership loader

### Completed Task
**Task:** Create reusable agent ownership loader for agents and tools routes
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/agent-helpers.ts`

2. **Extracted shared helper functions:**
   - `loadAgentForTenant()` - Load an agent and verify it belongs to the specified tenant; throws NotFoundError if not found
   - `tryLoadAgentForTenant()` - Same as above but returns null instead of throwing

3. **Exported types:**
   - `Agent` - Type alias for agent table row
   - `AgentOwnershipResult` - Return type for loadAgentForTenant

4. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/agents.ts` - Refactored 11 route handlers to use `loadAgentForTenant()`
   - `apps/api/src/routes/tools.ts` - Refactored 5 route handlers to use `loadAgentForTenant()`

5. **Added tests:**
   - `apps/api/src/services/agent-helpers.test.ts` - 10 tests covering module exports and function contracts

### Code Reduction
- Eliminated ~120 lines of duplicate agent ownership verification code
- Standardized error handling for agent not found scenarios
- Centralized the ownership check pattern into a single, well-documented function
- Routes now use a single function call instead of repeating the same 10-line pattern

### Files Changed
- `apps/api/src/services/agent-helpers.ts` (NEW)
- `apps/api/src/services/agent-helpers.test.ts` (NEW)
- `apps/api/src/routes/agents.ts` (MODIFIED)
- `apps/api/src/routes/tools.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)

## 2026-01-17: Extract shared knowledge base aggregation utilities

### Completed Task
**Task:** Extract shared knowledge base aggregation utilities (counts, summaries)
**Status:** COMPLETED

### Changes Made

1. **Created new shared helper module:**
   - `apps/api/src/services/kb-aggregation-helpers.ts`

2. **Extracted shared types:**
   - `KbCountResult` - Type for KB ID to count mapping
   - `KbAggregatedCounts` - Type for source and chunk counts
   - `KbAggregatedCountsWithShares` - Type including share counts for admin views

3. **Extracted grouped count functions (for KB lists):**
   - `getSourceCountsByKb()` - Get source counts grouped by KB ID
   - `getChunkCountsByKb()` - Get chunk counts grouped by KB ID
   - `getShareCountsByKb()` - Get subscription/share counts grouped by KB ID
   - `getKbCountMaps()` - Convenience function returning both source and chunk count maps
   - `getKbCountMapsWithShares()` - Returns source, chunk, and share count maps for admin views

4. **Extracted single KB count functions:**
   - `getKbSourceCount()` - Get source count for a single KB
   - `getKbChunkCount()` - Get chunk count for a single KB
   - `getKbAggregatedCounts()` - Get both source and chunk counts for a single KB

5. **Updated routes to use shared helpers:**
   - `apps/api/src/routes/knowledge-bases.ts` - Tenant KB list route
   - `apps/api/src/routes/admin/shared-kbs.ts` - Admin global KB list and details routes

6. **Added tests:**
   - `apps/api/src/services/kb-aggregation-helpers.test.ts` - 16 tests covering module exports and type definitions

### Code Reduction
- Eliminated ~60 lines of duplicate aggregation code between knowledge-bases.ts and shared-kbs.ts
- Centralized source, chunk, and share count queries prevent drift between routes
- All aggregation queries now use efficient parallel execution via Promise.all
- Empty kbIds array is handled efficiently (returns empty Map without DB query)

### Files Changed
- `apps/api/src/services/kb-aggregation-helpers.ts` (NEW)
- `apps/api/src/services/kb-aggregation-helpers.test.ts` (NEW)
- `apps/api/src/routes/knowledge-bases.ts` (MODIFIED)
- `apps/api/src/routes/admin/shared-kbs.ts` (MODIFIED)
- `Tasks/tasks.yml` (MODIFIED - marked task complete)
